Click Pro Assistant ‚Äî Sauda√ß√£o personalizada + di√°logo por cidade (Replit-ready)

Stack & vers√£o: Node 18+ ‚Ä¢ TypeScript

Entrega: projeto completo com sauda√ß√£o pelo nome (ex.: ‚ÄúOl√°, Thiago üëã‚Äù), detec√ß√£o do que o usu√°rio buscou, e perguntas guiadas sobre a cidade no Paraguai (Ciudad del Este, Salto del Guair√°, Pedro Juan Caballero). Mant√©m a l√≥gica regional, premium-first e integra com sua raspadinha.

√Årvore de diret√≥rios
click-pro-assistant/
‚îú‚îÄ .replit
‚îú‚îÄ replit.nix
‚îú‚îÄ package.json
‚îú‚îÄ tsconfig.json
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ index.ts
‚îÇ  ‚îú‚îÄ lib/
‚îÇ  ‚îÇ  ‚îú‚îÄ embed.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ vectorStore.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ tools.ts
‚îÇ  ‚îÇ  ‚îú‚îÄ promo.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ economy.ts
‚îÇ  ‚îú‚îÄ routes/
‚îÇ  ‚îÇ  ‚îú‚îÄ assistant.ts          # ‚Üê atualizado: sauda√ß√£o + cidades
‚îÇ  ‚îÇ  ‚îú‚îÄ simulator.ts
‚îÇ  ‚îÇ  ‚îî‚îÄ compare.ts
‚îÇ  ‚îî‚îÄ types.ts
‚îú‚îÄ data/
‚îÇ  ‚îú‚îÄ stores.json
‚îÇ  ‚îú‚îÄ products.json
‚îÇ  ‚îú‚îÄ hotels.json
‚îÇ  ‚îú‚îÄ restaurants.json
‚îÇ  ‚îî‚îÄ product_embeddings.json
‚îú‚îÄ web/
‚îÇ  ‚îú‚îÄ AssistantExperience.tsx   # ‚Üê atualizado: sauda√ß√µes, chips de cidades, fluxo guiado
‚îÇ  ‚îú‚îÄ SearchBarClick.tsx        # ‚Üê sem mudan√ßas funcionais (j√° refinado); coment√°rios claros
‚îÇ  ‚îú‚îÄ useSpeech.ts
‚îÇ  ‚îî‚îÄ ui-helpers.ts
‚îú‚îÄ .env.example
‚îú‚îÄ __tests__/
‚îÇ  ‚îî‚îÄ api.test.ts

Arquivos do Replit
# click-pro-assistant/.replit
run = "npm install && npm run dev"

# click-pro-assistant/replit.nix
{ pkgs }: {
  deps = [
    pkgs.nodejs-18_x
    pkgs.nodePackages.npm
  ];
}

// click-pro-assistant/package.json
{
  "name": "click-pro-assistant",
  "version": "1.0.0",
  "type": "module",
  "description": "Assistente de compras conversacional (CDE/Foz) com simulador e comparador - Replit Ready",
  "scripts": {
    "start": "tsx src/index.ts",
    "dev": "tsx --watch src/index.ts",
    "test": "jest -c"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "openai": "^4.58.1"
  },
  "devDependencies": {
    "tsx": "^4.7.0",
    "@types/node": "^20.11.0",
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "jest": "^29.7.0",
    "supertest": "^7.0.0",
    "ts-jest": "^29.1.1",
    "@types/supertest": "^2.0.16",
    "typescript": "^5.6.2"
  }
}

// click-pro-assistant/tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*", "web/**/*", "__tests__/**/*"]
}

Backend ‚Äî Assistant com sauda√ß√£o + cidades (atualizado)
// click-pro-assistant/src/routes/assistant.ts
/**
 * Rotas do Assistente (Click):
 * - POST /assistant/session ‚Üí cria sessionId (mock simples)
 * - POST /assistant/message ‚Üí processa a mensagem, PERSONALIZA pelo nome,
 *   entende inten√ß√£o, sugere produtos/lojas e pergunta pela CIDADE (CDE / Salto / Pedro Juan).
 *
 * Como o nome chega?
 * - Pelo header 'x-user-name' (ex.: "Thiago") e 'x-user-id' (UUID do usu√°rio logado).
 * - No front desse projeto, lemos de localStorage e reencaminhamos via cabe√ßalhos.
 */

import { Router } from 'express';
import OpenAI from 'openai';
import { searchSuggestions, buildItinerary } from '../lib/tools.js';
import { maybeAttachPromo } from '../lib/promo.js';

const router = Router();
const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const CHAT_MODEL = process.env.CHAT_MODEL || 'gpt-4o-mini';

const SYSTEM_PROMPT = `
Voc√™ √© o Click, assistente de compras/viagens focado em Ciudad del Este (lojas) e Foz/CDE (hotelaria).
Regras:
- Cumprimente o usu√°rio PELO NOME, se fornecido (ex.: "Ol√°, Thiago üëã").
- Se detectar uma inten√ß√£o de compra (ex.: "iphone", "perfume"), diga "vi que voc√™ est√° buscando X, vou te apresentar as melhores ofertas de hoje".
- Confirme a cidade no Paraguai para o roteiro: op√ß√µes can√¥nicas s√£o "Ciudad del Este", "Salto del Guair√°" ou "Pedro Juan Caballero". Pergunte de forma clara.
- D√™ respostas curtas e objetivas; portugu√™s (Brasil).
- Traga dicas antifraude (nota fiscal, PDV oficial, verificar lacres/IMEI, c√¢mbio).
- N√£o invente pre√ßos/estoques; use apenas o contexto fornecido pelo servidor.
`;

/** Cria uma sess√£o simples (mock). */
router.post('/session', (_req, res)=>{
  const id = 'sess-' + Math.random().toString(36).slice(2,10);
  res.json({ ok:true, sessionId: id, createdAt: new Date().toISOString() });
});

/** Conversa do assistente. */
router.post('/message', async (req, res)=>{
  try{
    const sessionId = (req.body?.sessionId || '').toString();
    const message   = (req.body?.message || '').toString();
    const wishlist  = Array.isArray(req.body?.wishlist) ? req.body.wishlist : [];

    // Identidade do usu√°rio logado (headers vindos do front)
    const userId    = (req.headers['x-user-id'] || '').toString();
    const userName  = (req.headers['x-user-name'] || '').toString(); // ‚Üê usado na sauda√ß√£o
    const ip        = req.headers['x-forwarded-for']?.toString().split(',')[0] || req.socket.remoteAddress || '';

    if (!sessionId || !message) return res.status(400).json({ ok:false, error:'sessionId e message s√£o obrigat√≥rios' });

    // Sugest√µes (produtos + lojas) e esqueleto de roteiro
    const suggest = await searchSuggestions(message);
    const itinerary = await buildItinerary({ wishlist });

    // Instru√ß√µes adicionais para personaliza√ß√£o
    const personalization = {
      userName: userName || null,
      paraguayCities: ['Ciudad del Este', 'Salto del Guair√°', 'Pedro Juan Caballero'],
      intentHint: message
    };

    const messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [
      { role:'system', content: SYSTEM_PROMPT },
      { role:'system', content: `Contexto (sugest√µes): ${JSON.stringify(suggest)}` },
      { role:'system', content: `Contexto (itiner√°rio): ${JSON.stringify(itinerary)}` },
      { role:'system', content: `Personaliza√ß√£o: ${JSON.stringify(personalization)}` },
      { role:'user', content: message }
    ];

    const r = await client.chat.completions.create({ model: CHAT_MODEL, messages, temperature: 0.2 });
    const payload: any = {
      ok:true, sessionId,
      reply: r.choices[0].message.content,
      suggest, itinerary,
      personalization: { userName, paraguayCities: personalization.paraguayCities }
    };

    // Anexa raspadinha quando aplic√°vel (n√£o bloqueia)
    await maybeAttachPromo(payload, userId, ip, { route:'assistant/message', message, wishlist });

    res.json(payload);
  }catch(e){
    console.error(e); res.status(500).json({ ok:false, error:'falha no assistente' });
  }
});

export default router;


Coment√°rios no topo explicam como o nome chega e como √© usado no prompt.

Front ‚Äî P√°gina do Assistente com conversa guiada (atualizado)
// click-pro-assistant/web/AssistantExperience.tsx
/**
 * AssistantExperience (UI):
 * - Sa√∫da o usu√°rio pelo nome (se dispon√≠vel via localStorage.userName).
 * - Quando o usu√°rio busca algo (via SearchBarClick), envia ao /assistant/message
 *   com cabe√ßalhos 'x-user-id' e 'x-user-name' para PERSONALIZA√á√ÉO.
 * - Ap√≥s responder, o Click pergunta a cidade (CDE / Salto / Pedro Juan) com CHIPS.
 * - Spotlight (centro) mostra o melhor produto do momento; A√ß√µes (direita) com Comparar/Simular/Salvar.
 */

import React, { useEffect, useMemo, useRef, useState } from 'react';
import { SearchBarClick } from './SearchBarClick';
import { Chip, ActionButton, Skeleton } from './ui-helpers';

type Msg = { role:'user'|'assistant'; content:string };
type AssistantPayload = { reply: string; suggest?: any; personalization?: { userName?: string; paraguayCities?: string[] } };

export default function AssistantExperience(){
  // Identidade do usu√°rio (mock simples para Replit / seu app injeta isso ao logar)
  const uid = useMemo(()=> localStorage.getItem('uid') || (localStorage.setItem('uid', 'u-'+Math.random().toString(36).slice(2,8)), localStorage.getItem('uid')!), []);
  const userName = useMemo(()=> localStorage.getItem('userName') || 'Cliente', []);

  const [messages, setMessages] = useState<Msg[]>([
    { role:'assistant', content:`Ol√°, ${userName} üëã Sou o Click. O que voc√™ quer encontrar hoje em CDE/Paraguai?` }
  ]);
  const [sessionId, setSessionId] = useState<string>('');
  const [spotlight, setSpotlight] = useState<any>(null);
  const [loadingSpotlight, setLoadingSpotlight] = useState<boolean>(false);
  const [actions, setActions] = useState<any[]>([]);
  const [city, setCity] = useState<string>(''); // CDE / Salto / Pedro Juan

  const scRef = useRef<HTMLDivElement>(null);

  // Cria sess√£o
  useEffect(()=> {
    fetch('/assistant/session',{ method:'POST'}).then(r=>r.json()).then(d=> setSessionId(d.sessionId));
  }, []);

  // Auto scroll no chat
  useEffect(()=> { scRef.current?.scrollTo({ top: scRef.current.scrollHeight, behavior:'smooth' }); }, [messages]);

  // Quick replies base
  const quickReplies = useMemo(()=> ([
    { label: 'üì± iPhone', q: 'iphone' },
    { label: 'üíÑ Perfumes', q: 'perfumes' },
    { label: 'üéß Fones custo-benef√≠cio', q: 'fones custo-benef√≠cio' },
    { label: 'üó∫Ô∏è Roteiro 1 dia', q: 'roteiro 1 dia tech+perfume' }
  ]), []);

  async function sendToAssistant(q:string){
    setMessages(m=> [...m, { role:'user', content: q }]);
    setLoadingSpotlight(true);

    const r = await fetch('/assistant/message',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-user-id': uid,
        'x-user-name': userName   // ‚Üê nome vai pro backend pra sauda√ß√£o
      },
      body: JSON.stringify({
        sessionId,
        message: q + (city ? ` | cidade=${city}` : '')
      })
    });
    const data: AssistantPayload = await r.json();

    // Resposta conversacional do Click (j√° vem com "Ol√°, Nome" se houver)
    setMessages(m=> [...m, { role:'assistant', content: data.reply }]);

    // Spotlight e a√ß√µes
    const best = data?.suggest?.products?.[0] || null;
    setSpotlight(best);
    setLoadingSpotlight(false);

    setActions([
      { key:'compare', label:'üîÑ Comparar pre√ßos', handler: async ()=>{
        const title = best?.title || q;
        const cr = await fetch('/compare',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ query: title })}).then(r=>r.json());
        const top = cr.items?.[0];
        alert(top ? `Melhor: ${top.title} ‚Äî ${top.store?.name}` : 'Nenhum comparativo encontrado.');
      }},
      { key:'simulate', label:'üí∞ Simular economia', handler: async ()=>{
        const usd = best?.price?.USD || 0;
        if (!usd) return alert('Sem pre√ßo USD para simular.');
        const sr = await fetch(`/simulator/savings?usd=${usd}`).then(r=>r.json());
        const net = sr?.results?.net_saving ?? 0;
        alert(`Economia l√≠quida estimada: R$ ${Number(net).toFixed(2)}`);
      }},
      { key:'save', label:'‚≠ê Salvar', handler: ()=> alert('Adicionado √† sua lista!') }
    ]);

    // Se ainda n√£o temos cidade selecionada, ofere√ßa chips com as 3 op√ß√µes
    if (!city) {
      const opts = data.personalization?.paraguayCities || ['Ciudad del Este', 'Salto del Guair√°', 'Pedro Juan Caballero'];
      setMessages(m=> [...m, {
        role:'assistant',
        content: `Para eu te guiar melhor, em qual cidade do Paraguai voc√™ pretende visitar?`
      }]);
      setCityPicker(opts);
    }
  }

  // Estado para mostrar os chips de cidade (UX guiada)
  const [cityOptions, setCityPicker] = useState<string[]|null>(null);

  function chooseCity(c: string){
    setCity(c);
    setCityPicker(null);
    setMessages(m=> [...m, { role:'user', content: `Vou em ${c}.` }]);
    // Dica: voc√™ pode automaticamente reenviar a √∫ltima inten√ß√£o j√° com a cidade.
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 p-4">
      <div className="max-w-7xl mx-auto grid grid-cols-12 gap-4">
        {/* Esquerda ‚Äî Chat */}
        <div className="col-span-12 lg:col-span-4 rounded-3xl border bg-white/70 backdrop-blur p-0 shadow-sm overflow-hidden">
          <div className="p-4 border-b flex items-center gap-3">
            <div className="w-9 h-9 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-500 text-white grid place-content-center font-semibold">C</div>
            <div>
              <div className="font-semibold">Click Assistant</div>
              <div className="text-xs text-gray-500">Ol√°, {userName} ‚Äî pronto para ajudar!</div>
            </div>
          </div>

          <div ref={scRef} className="h-[52vh] overflow-auto p-4 space-y-2">
            {messages.map((m,i)=>(
              <div key={i} className={`whitespace-pre-wrap ${m.role==='user'?'text-right':''}`}>
                <span className={`inline-block px-3 py-2 rounded-2xl
                  ${m.role==='user'?'bg-indigo-100':'bg-gray-100'}`}>
                  {m.content}
                </span>
              </div>
            ))}

            {/* Chips de cidade quando necess√°rio */}
            {cityOptions && (
              <div className="mt-2 flex flex-wrap gap-2">
                {cityOptions.map(c => (
                  <Chip key={c} label={c} onClick={()=> chooseCity(c)} />
                ))}
              </div>
            )}
          </div>

          {/* Quick replies + Input */}
          <div className="px-4 pb-3 space-y-3">
            <div className="flex flex-wrap gap-2">
              {quickReplies.map(q => <Chip key={q.label} label={q.label} onClick={()=> sendToAssistant(q.q)} />)}
            </div>
          </div>
          <div className="p-4 border-t">
            <SearchBarClick onOpenAssistant={sendToAssistant}/>
          </div>
        </div>

        {/* Centro ‚Äî Spotlight */}
        <div className="col-span-12 lg:col-span-5 rounded-3xl border bg-white/70 backdrop-blur p-5 shadow-sm">
          <div className="text-sm text-gray-500 mb-2">Spotlight</div>
          {!spotlight && !loadingSpotlight && (
            <div className="text-gray-500">Busque algo (ex.: ‚Äúiphone‚Äù) para ver as melhores ofertas de hoje.</div>
          )}
          {loadingSpotlight && <Skeleton lines={5} />}
          {!!spotlight && !loadingSpotlight && (
            <div className="space-y-3">
              <div>
                <div className="text-xl font-semibold">{spotlight.title}</div>
                <div className="text-xs text-gray-500">{spotlight.category || '‚Äî'}</div>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-2xl font-semibold">USD {spotlight?.price?.USD ?? '-'}</div>
                {'score' in spotlight && spotlight.score !== undefined ? (
                  <div className="text-sm text-gray-500">score {spotlight.score}</div>
                ) : null}
              </div>
              <ul className="text-xs text-gray-600 list-disc pl-5 space-y-1">
                <li>Prefira lojas formais (nota fiscal/garantia).</li>
                <li>Pague no PDV oficial; evite QR/links de terceiros.</li>
                <li>Verifique lacres/IMEI em eletr√¥nicos. Compare c√¢mbio efetivo.</li>
              </ul>
            </div>
          )}
        </div>

        {/* Direita ‚Äî A√ß√µes */}
        <div className="col-span-12 lg:col-span-3 rounded-3xl border bg-white/70 backdrop-blur p-5 shadow-sm">
          <div className="text-sm text-gray-500 mb-2">A√ß√µes</div>
          <div className="grid gap-2">
            {actions.length ? actions.map(a=>(
              <ActionButton key={a.key} onClick={a.handler}>{a.label}</ActionButton>
            )) : <div className="text-sm text-gray-500">As a√ß√µes aparecem ap√≥s uma busca.</div>}
          </div>
        </div>
      </div>
    </div>
  );
}

UI ‚Äî Barra de Busca (mantida com coment√°rios claros)
// click-pro-assistant/web/SearchBarClick.tsx
/**
 * SearchBarClick:
 * - Campo conversacional com efeito clean + voz
 * - Sugest√µes em tempo real de lojas e produtos
 * - onOpenAssistant(q): usado para acionar a conversa do Click com a pergunta
 */
import React, { useEffect, useRef, useState } from 'react';
import { useSpeechRecognition } from './useSpeech';

type Store = { id:string; name:string; label?:string; mall?:string };
type Product = { id:string; title:string; category?:string; score?:number; price?: any };
type SuggestResponse = { ok:boolean; category?:string; topStores:Store[]; products:Product[]; scratchcard?:any };

export function SearchBarClick({ onOpenAssistant }: { onOpenAssistant?: (query:string)=>void }) {
  const [value,setValue] = useState(''); const [focused,setFocused]=useState(false);
  const [open,setOpen]   = useState(false); const [sug,setSug]=useState<SuggestResponse|null>(null);
  const [loading,setLoading]=useState(false);
  const { state, transcript, start, stop, isSupported } = useSpeechRecognition();
  const boxRef = useRef<HTMLDivElement>(null);

  useEffect(()=> { if (transcript) setValue(transcript); }, [transcript]);
  useEffect(()=> {
    const h=(e:MouseEvent)=>{ if(boxRef.current && !boxRef.current.contains(e.target as Node)) setOpen(false); };
    window.addEventListener('mousedown',h); return ()=> window.removeEventListener('mousedown',h);
  }, []);

  async function fetchSuggestions(q:string){
    try{
      setLoading(true);
      const r = await fetch(`/suggest?q=${encodeURIComponent(q)}`, { headers:{ 'x-user-id': localStorage.getItem('uid') || '' }});
      const data = await r.json(); setSug(data); setOpen(true);
    }finally{ setLoading(false); }
  }
  useEffect(()=> {
    const q=value.trim(); if(!q){ setSug(null); setOpen(false); return; }
    const t=setTimeout(()=> fetchSuggestions(q), 220); return ()=> clearTimeout(t);
  }, [value]);

  function handleSubmit(e:React.FormEvent){
    e.preventDefault();
    const q=value.trim(); if(!q) return;
    onOpenAssistant?.(q);
    setOpen(false);
  }

  return (
    <div ref={boxRef} className="relative">
      <form onSubmit={handleSubmit}
        className={`flex items-center gap-2 rounded-2xl px-4 py-2 transition-all
          ${focused ? 'shadow-[0_0_0_6px_rgba(99,102,241,0.15)] scale-[1.01]' : 'shadow'} bg-white`}>
        <div className="flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 text-white text-xs">C</div>
        <input
          value={value}
          onChange={(e)=>setValue(e.target.value)}
          onFocus={()=>setFocused(true)}
          onBlur={()=>setFocused(false)}
          placeholder="Fale com o Click (ex.: iPhone + perfume em CDE)"
          className="flex-1 outline-none text-base"
        />
        <button type="submit" className="px-3 py-1 rounded-lg bg-black text-white hover:opacity-90">Perguntar</button>
        {isSupported && (
          <button type="button" onClick={state==='listening'? stop : start}
            title="Busca por voz"
            className={`px-3 py-1 rounded-lg border transition-colors ${state==='listening' ? 'bg-red-600 text-white' : 'bg-white hover:bg-gray-100'}`}>
            {state==='listening' ? '‚óè Gravando' : 'üé§'}
          </button>
        )}
      </form>

      {open && sug && (
        <div className="absolute z-50 mt-2 w-full rounded-2xl border bg-white shadow-xl p-3">
          <div className="text-xs text-gray-500 mb-2">
            {loading ? 'Carregando‚Ä¶' : (sug.category ? `Sugest√µes ‚Äî categoria: ${sug.category}` : 'Sugest√µes')}
          </div>

          {sug.topStores?.length>0 && (
            <div className="mb-3">
              <div className="text-sm font-semibold mb-1">Melhores lojas</div>
              <div className="grid grid-cols-1 gap-1">
                {sug.topStores.map((s,i)=>(
                  <div key={s.id}
                       className="flex items-center justify-between px-2 py-1 rounded-xl hover:bg-gray-50 cursor-pointer"
                       onMouseDown={(e)=> e.preventDefault()}
                       onClick={()=> setValue(s.name)}>
                    <div className="truncate">
                      {i<2 && s.label ? (
                        <span className="mr-2 text-[10px] px-1 py-0.5 rounded bg-amber-100 border border-amber-300">{s.label}</span>
                      ) : null}
                      {s.name}
                    </div>
                    {s.mall ? <span className="text-xs text-gray-500">{s.mall}</span> : null}
                  </div>
                ))}
              </div>
            </div>
          )}

          {sug.products?.length>0 && (
            <div>
              <div className="text-sm font-semibold mb-1">Produtos em alta</div>
              <div className="grid grid-cols-1 gap-1">
                {sug.products.map((p)=>(
                  <div key={p.id}
                       className="px-2 py-1 rounded-xl hover:bg-gray-50 cursor-pointer"
                       onMouseDown={(e)=> e.preventDefault()}
                       onClick={()=> setValue(p.title)}>
                    <div className="truncate">{p.title}</div>
                    <div className="text-xs text-gray-500 flex items-center gap-2">
                      {p.category ? <span>{p.category}</span> : null}
                      {'score' in p && p.score !== undefined ? <span className="opacity-60">score {p.score}</span> : null}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {(sug.topStores?.length===0 && sug.products?.length===0) && (
            <div className="text-sm text-gray-500">Sem sugest√µes agora. Tente outro termo.</div>
          )}
        </div>
      )}
    </div>
  );
}

Backend base e libs (mesmos da vers√£o anterior)

Os arquivos abaixo permanecem os mesmos da sua vers√£o anterior (j√° funcionais). Repeti aqui os cabe√ßalhos dos caminhos para facilitar se quiser colar:

src/index.ts (servidor Express com /health, /index-products, /suggest, /assistant, /simulator, /compare)

src/lib/embed.ts, src/lib/vectorStore.ts, src/lib/tools.ts, src/lib/promo.ts, src/lib/economy.ts

src/routes/simulator.ts, src/routes/compare.ts

src/types.ts

dados em data/*.json

Se precisar reenviar algum deles, eu mando de novo na √≠ntegra.

Como rodar

Crie um Repl (Node.js) e cole a pasta click-pro-assistant/.

Copie .env.example para .env e defina:

OPENAI_API_KEY=YOUR_OPENAI_API_KEY


Run (usa tsx).

Gere o √≠ndice (1¬™ vez):

curl -X POST http://localhost:3000/index-products


Testes r√°pidos:

curl "http://localhost:3000/health"
curl "http://localhost:3000/suggest?q=iphone"
curl -X POST http://localhost:3000/assistant/session
curl -X POST http://localhost:3000/assistant/message \
  -H "Content-Type: application/json" \
  -H "x-user-id: u-123" -H "x-user-name: Thiago" \
  -d '{"sessionId":"sess-demo","message":"quero iphone"}'

Como o nome do usu√°rio chega ao Click (importante)

Seu app deve preencher no browser (ap√≥s login):

localStorage.setItem('uid', 'USER_ID_SEGURO');
localStorage.setItem('userName', 'Thiago');


O front deste projeto envia esses dados para o backend em todos os POSTs do assistente via headers:

x-user-id (para cooldown/raspadinha/analytics)

x-user-name (para sauda√ß√£o personalizada)

Notas/Recomenda√ß√µes

Cidades can√¥nicas: j√° passamos ‚ÄúCiudad del Este‚Äù, ‚ÄúSalto del Guair√°‚Äù e ‚ÄúPedro Juan Caballero‚Äù ao modelo para a pergunta guiada.

Tom de voz: curto, claro, com ‚Äúvi que voc√™ est√° buscando X, vou te apresentar as melhores ofertas de hoje‚Äù.

Sem reservas: seguimos mostrando informa√ß√µes; sem efetuar booking.

Privacidade: envie apenas nome e um user-id an√¥nimo (nada de PII sens√≠vel).

Raspadinha: segue opcional; se sua engine liberar, o payload retorna scratchcard ‚Äî sua UI abre o modal.

Se quiser, adiciono persist√™ncia da cidade preferida do usu√°rio (ex.: localStorage.city) e fa√ßo o Click lembrar essa escolha nas pr√≥ximas conversas automaticamente. Quer que eu inclua isso tamb√©m?

Voc√™ disse:
entao eu quero que esse codigo seja implementado na barra de busca, ou seja quando o usuario clicar na barra ela se espande um pouco e ai come√ßa o atendimento e nesse momento os produtos e sujestoes de compras tem que ir aparecendo na tela abaixo
Programador Senior - Dev GPT ‚Äî Replit Ready disse:
Pensou por 9s
Click Pro ‚Äî Barra de Busca ‚Äúviva‚Äù (expande + inicia atendimento)

Stack & vers√£o: Node 18+ ‚Ä¢ TypeScript ‚Ä¢ Replit-ready

Abaixo est√£o os arquivos de UI para voc√™ colar no seu projeto click-pro-assistant (ou no seu app). Eles fazem exatamente o que voc√™ pediu:

Ao clicar na barra, ela expande (anima√ß√£o) e inicia o atendimento (‚ÄúOl√°, Thiago üëã ‚Ä¶‚Äù).

As sugest√µes e ofertas passam a aparecer na √°rea abaixo da barra (em cards), atualizando em tempo real conforme o usu√°rio digita.

Mant√©m busca por voz, prioriza√ß√£o premium, e usa seus endpoints j√° existentes (/assistant/session, /assistant/message, /suggest).

Obs.: backend n√£o precisa mudar. S√≥ garanta que j√° est√° rodando o servidor (os mesmos endpoints da vers√£o anterior).

Onde colocar (estrutura)

Coloque estes 3 arquivos na pasta web/ do seu projeto:

web/
‚îú‚îÄ SearchDock.tsx            ‚Üê NOVO: container da busca + painel abaixo
‚îú‚îÄ SearchBarClick.tsx        ‚Üê ATUALIZADO: anima√ß√£o/expans√£o e callbacks
‚îî‚îÄ useSpeech.ts              ‚Üê (igual ao seu, mantido)


Se voc√™ ainda n√£o tem ui-helpers.ts (chips/bot√µes/skeleton) da vers√£o anterior, crie-o tamb√©m (opcional, s√≥ para estilo).

1) Container: painel de atendimento e resultados (NOVO)
// web/SearchDock.tsx
/**
 * SearchDock
 * -----------
 * Container que agrupa:
 *  - Barra de busca (SearchBarClick)
 *  - Painel de atendimento abaixo (sauda√ß√£o do Click + cards de sugest√µes)
 * Fluxo:
 *  1) Ao focar a barra ‚Üí cria sess√£o (se necess√°rio) e envia "oi" para /assistant ‚Üí mensagem "Ol√°, {nome}".
 *  2) Ao digitar ‚Üí chama /suggest e atualiza os cards abaixo (lojas e produtos).
 *  3) Ao enviar (Enter) ‚Üí mant√©m sugest√µes e voc√™ pode trat√°-lo como "abrir p√°gina de resultados" ou seguir no chat.
 *
 * Integra√ß√£o:
 *  - GET  /suggest?q=...
 *  - POST /assistant/session
 *  - POST /assistant/message   (headers: x-user-id, x-user-name)
 */

import React, { useEffect, useMemo, useRef, useState } from 'react';
import { SearchBarClick } from './SearchBarClick';

type Store = { id:string; name:string; label?:string; mall?:string };
type Product = { id:string; title:string; category?:string; price?:any; score?:number; storeId?:string };
type SuggestResponse = { ok:boolean; category?:string; topStores:Store[]; products:Product[]; scratchcard?:any };

export default function SearchDock() {
  // Identidade do usu√°rio (mock simples para Replit; seu app j√° ter√° isso ap√≥s login)
  const uid = useMemo(()=> localStorage.getItem('uid') || (localStorage.setItem('uid', 'u-'+Math.random().toString(36).slice(2,8)), localStorage.getItem('uid')!), []);
  const userName = useMemo(()=> localStorage.getItem('userName') || 'Cliente', []);

  const [sessionId, setSessionId] = useState<string>('');
  const [greeting, setGreeting] = useState<string>('');          // Sauda√ß√£o do Click (‚ÄúOl√°, Thiago‚Ä¶‚Äù)
  const [query, setQuery] = useState<string>('');                // Texto atual da barra
  const [sug, setSug] = useState<SuggestResponse | null>(null);  // Sugest√µes atuais
  const [loading, setLoading] = useState<boolean>(false);

  // Cria sess√£o ao montar
  useEffect(()=> {
    fetch('/assistant/session',{ method:'POST'}).then(r=>r.json()).then(d=> setSessionId(d.sessionId));
  }, []);

  // Quando a barra recebe foco, iniciamos o atendimento (sauda√ß√£o + contexto)
  async function handleFocusStart() {
    try {
      if (!sessionId) return;
      const r = await fetch('/assistant/message', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'x-user-id': uid,
          'x-user-name': userName
        },
        body: JSON.stringify({
          sessionId,
          message: 'oi' // for√ßa uma sauda√ß√£o breve
        })
      });
      const data = await r.json();
      // A reply j√° vem com "Ol√°, {nome}‚Ä¶" (gra√ßas ao prompt do backend)
      setGreeting(data?.reply || `Ol√°, ${userName} üëã Posso ajudar na sua compra hoje?`);
      // Se vier produtos/l lojas na sauda√ß√£o inicial, podemos mostrar tamb√©m:
      if (data?.suggest) {
        setSug({ ok:true, ...data.suggest });
      }
    } catch {
      setGreeting(`Ol√°, ${userName} üëã Posso ajudar na sua compra hoje?`);
    }
  }

  // Atualiza cards conforme digita (chama /suggest)
  async function handleQueryChange(text:string){
    setQuery(text);
    const q = text.trim();
    if (!q) { setSug(null); return; }
    try{
      setLoading(true);
      const r = await fetch(`/suggest?q=${encodeURIComponent(q)}`, { headers: { 'x-user-id': uid }});
      const data = await r.json();
      setSug(data);
    } finally {
      setLoading(false);
    }
  }

  // Submit (Enter) ‚Äî voc√™ pode redirecionar para uma p√°gina ou continuar no painel
  async function handleSubmit(text:string){
    // Mantemos as sugest√µes; opcionalmente voc√™ pode navegar para /resultados?q=...
    console.log('Consulta enviada:', text);
  }

  return (
    <div className="w-full">
      {/* Barra de busca no topo, que expande ao focar e dispara a sauda√ß√£o */}
      <SearchBarClick
        onFocusStart={handleFocusStart}
        onChangeQuery={handleQueryChange}
        onSubmitQuery={handleSubmit}
      />

      {/* Painel abaixo da barra: sauda√ß√£o + sugest√µes em cards */}
      <div className="mt-4 space-y-4">
        {/* Sauda√ß√£o do Click */}
        {greeting ? (
          <div className="rounded-2xl border bg-white/80 backdrop-blur p-4 shadow-sm">
            <div className="text-sm text-gray-500 mb-1">Atendimento Click</div>
            <div className="whitespace-pre-wrap">{greeting}</div>
            <div className="text-xs text-gray-500 mt-2">
              Dica: diga o que procura (ex.: ‚Äúiphone‚Äù ou ‚Äúroteiro 1 dia tech+perfume‚Äù).
            </div>
          </div>
        ) : (
          <div className="rounded-2xl border bg-white/60 p-4 text-gray-500">
            Clique na barra para iniciar o atendimento do Click.
          </div>
        )}

        {/* Sugest√µes/Resultados (sempre abaixo da barra) */}
        <div className="rounded-2xl border bg-white/80 backdrop-blur p-4 shadow-sm">
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm text-gray-500">
              {loading ? 'Buscando ofertas‚Ä¶' : (query ? `Resultados para ‚Äú${query}‚Äù` : 'Ofertas e destaques')}
            </div>
            {sug?.category ? <div className="text-xs px-2 py-1 rounded-full border bg-gray-50">{sug.category}</div> : null}
          </div>

          {/* Grid principal: lojas premium e produtos em alta/sem√¢nticos */}
          {!sug ? (
            <div className="text-gray-500 text-sm">Sem resultados ainda. Digite algo na barra acima.</div>
          ) : (
            <div className="grid grid-cols-12 gap-4">
              {/* Coluna de lojas */}
              <div className="col-span-12 md:col-span-4">
                <div className="text-sm font-semibold mb-2">Melhores lojas</div>
                <div className="grid gap-2">
                  {(sug.topStores || []).map((s, i) => (
                    <div key={s.id} className="p-3 rounded-xl border hover:shadow-sm transition-all">
                      <div className="flex items-center justify-between">
                        <div className="font-medium truncate">{s.name}</div>
                        {i<2 && s.label ? (
                          <span className="text-[10px] px-1 py-0.5 rounded bg-amber-100 border border-amber-300">{s.label}</span>
                        ) : null}
                      </div>
                      {s.mall ? <div className="text-xs text-gray-500 mt-1">{s.mall}</div> : null}
                    </div>
                  ))}
                  {(!sug.topStores || !sug.topStores.length) && (
                    <div className="text-xs text-gray-500">Nenhuma loja no momento.</div>
                  )}
                </div>
              </div>

              {/* Coluna de produtos */}
              <div className="col-span-12 md:col-span-8">
                <div className="text-sm font-semibold mb-2">Ofertas e produtos</div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {(sug.products || []).map((p) => (
                    <div key={p.id} className="p-3 rounded-xl border hover:shadow-sm transition-all">
                      <div className="font-medium truncate mb-1">{p.title}</div>
                      <div className="text-xs text-gray-500 mb-2">
                        {p.category || '‚Äî'} {('score' in p && p.score !== undefined) ? `‚Ä¢ score ${p.score}` : ''}
                      </div>
                      <div className="text-sm">
                        {p.price?.USD ? <>USD <b>{p.price.USD}</b></> : <span className="text-gray-400">sem pre√ßo</span>}
                      </div>
                    </div>
                  ))}
                  {(!sug.products || !sug.products.length) && (
                    <div className="text-xs text-gray-500">Nenhum produto encontrado.</div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}


O que este arquivo faz (resumo):

Cria sess√£o com o Click.

Ao focar a barra: envia ‚Äúoi‚Äù para /assistant/message passando x-user-name ‚Üí recebe a sauda√ß√£o ‚ÄúOl√°, Thiago‚Ä¶‚Äù.

Renderiza cards de lojas/produtos abaixo da barra (n√£o √© dropdown).

Atualiza os cards conforme digita (chamando /suggest).

2) Barra de busca (ATUALIZADA: expans√£o + callbacks)
// web/SearchBarClick.tsx
/**
 * SearchBarClick
 * --------------
 * - Barra conversacional com anima√ß√£o de expans√£o ao focar.
 * - Voz (Web Speech API).
 * - Em vez de dropdown, delega a exibi√ß√£o de resultados ao container (SearchDock).
 *
 * Props:
 *  - onFocusStart(): chamado no primeiro foco ‚Üí para iniciar atendimento e sauda√ß√£o.
 *  - onChangeQuery(texto): chamado a cada digita√ß√£o com debounce leve ‚Üí para buscar /suggest.
 *  - onSubmitQuery(texto): chamado no Enter ‚Üí voc√™ decide o que fazer (navegar, abrir chat etc).
 */

import React, { useEffect, useRef, useState } from 'react';
import { useSpeechRecognition } from './useSpeech';

export function SearchBarClick({
  onFocusStart,
  onChangeQuery,
  onSubmitQuery
}: {
  onFocusStart?: () => void;
  onChangeQuery?: (q: string) => void;
  onSubmitQuery?: (q: string) => void;
}) {
  const [value,setValue] = useState('');        // texto digitado
  const [focused,setFocused]=useState(false);   // controla anima√ß√£o de expans√£o
  const firstFocusRef = useRef(false);

  const { state, transcript, start, stop, isSupported } = useSpeechRecognition();

  // transcript da voz ‚Üí input
  useEffect(()=> { if (transcript) setValue(transcript); }, [transcript]);

  // dispara onChangeQuery com debounce
  useEffect(()=> {
    const q = value.trim();
    const t = setTimeout(()=> onChangeQuery?.(q), 220);
    return ()=> clearTimeout(t);
  }, [value, onChangeQuery]);

  function handleFocus(){
    setFocused(true);
    if (!firstFocusRef.current) {
      firstFocusRef.current = true;
      onFocusStart?.(); // inicia atendimento apenas na primeira vez que focar
    }
  }
  function handleBlur(){ setFocused(false); }

  function handleSubmit(e:React.FormEvent){
    e.preventDefault();
    const q = value.trim(); if (!q) return;
    onSubmitQuery?.(q);
  }

  return (
    <div className="w-full">
      {/* Caixa com anima√ß√£o (glow + scale) ao focar */}
      <form onSubmit={handleSubmit}
        className={`flex items-center gap-2 rounded-2xl px-4 py-3 transition-all bg-white shadow
          ${focused ? 'shadow-[0_0_0_8px_rgba(99,102,241,0.15)] scale-[1.02]' : ''}`}>
        <div className="flex items-center justify-center w-7 h-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 text-white text-xs">C</div>

        <input
          value={value}
          onChange={(e)=>setValue(e.target.value)}
          onFocus={handleFocus}
          onBlur={handleBlur}
          placeholder="Fale com o Click (ex.: iPhone + perfume em CDE)"
          className="flex-1 outline-none text-base"
        />

        <button type="submit" className="px-3 py-1.5 rounded-lg bg-black text-white hover:opacity-90">Buscar</button>

        {isSupported && (
          <button type="button" onClick={state==='listening'? stop : start}
            title="Busca por voz"
            className={`px-3 py-1.5 rounded-lg border transition-colors ${state==='listening' ? 'bg-red-600 text-white' : 'bg-white hover:bg-gray-100'}`}>
            {state==='listening' ? '‚óè Gravando' : 'üé§'}
          </button>
        )}
      </form>
    </div>
  );
}


O que mudou aqui:

Expans√£o visual (scale + glow) ao focar.

Em vez de renderizar dropdown, ele notifica o container (SearchDock) via onChangeQuery e onSubmitQuery.

onFocusStart dispara uma vez ao primeiro foco ‚Üí usado para a sauda√ß√£o.

3) Hook de voz (igual ao anterior, s√≥ deixe presente)
// web/useSpeech.ts
import { useCallback, useEffect, useRef, useState } from 'react';
type SpeechState = 'idle'|'listening'|'error'|'unsupported';

export function useSpeechRecognition() {
  const [state, setState] = useState<SpeechState>('idle');
  const [transcript, setTranscript] = useState('');
  const recRef = useRef<any>(null);
  const isSupported = typeof window !== 'undefined' && (('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window));

  useEffect(()=> {
    if (!isSupported) { setState('unsupported'); return; }
    const SR:any = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
    const rec = new SR(); rec.lang='pt-BR'; rec.interimResults=true; rec.continuous=false;
    rec.onstart = ()=> setState('listening');
    rec.onerror = ()=> setState('error');
    rec.onend   = ()=> setState('idle');
    rec.onresult= (e:any)=> { let t=''; for(let i=e.resultIndex;i<e.results.length;i++){ t += e.results[i][0].transcript; } setTranscript(t); };
    recRef.current = rec; return ()=> rec?.abort?.();
  }, [isSupported]);

  const start = useCallback(()=> { if (recRef.current && isSupported){ setTranscript(''); recRef.current.start(); } }, [isSupported]);
  const stop  = useCallback(()=> { recRef.current?.stop?.(); }, []);
  return { state, transcript, start, stop, isSupported };
}

Como usar no seu app (plug-and-play)

Na p√°gina onde fica sua barra de busca, importe e use o SearchDock:

// Exemplo em alguma p√°gina/layout do seu app
import React from 'react';
import SearchDock from '/web/SearchDock'; // ajuste o caminho conforme sua estrutura

export default function Home() {
  return (
    <div className="p-4 bg-gray-50 min-h-screen">
      {/* Cabe√ßalho, nav, etc... */}
      <div className="max-w-5xl mx-auto">
        <SearchDock />
      </div>
    </div>
  );
}


Dica: garanta que, ap√≥s login, voc√™ coloca no navegador:

localStorage.setItem('uid', 'USER_ID_AQUI');
localStorage.setItem('userName', 'Thiago');


Assim, o Click j√° cumprimenta pelo nome.

Por que assim

Mantemos um √∫nico lugar respons√°vel por UX/busca (o SearchDock), enquanto a barra (SearchBarClick) cuida s√≥ do input e anima√ß√µes.

O backend continua igual: /assistant/session, /assistant/message, /suggest.

O fluxo fica exatamente como voc√™ pediu: clicou ‚Üí expande ‚Üí ‚ÄúOl√°, {nome}‚Äù ‚Üí ofertas abaixo.

Se quiser, adiciono chips de cidade (CDE / Salto / Pedro Juan) logo abaixo da sauda√ß√£o e fa√ßo o SearchDock enviar automaticamente essa informa√ß√£o no pr√≥ximo /assistant/message.