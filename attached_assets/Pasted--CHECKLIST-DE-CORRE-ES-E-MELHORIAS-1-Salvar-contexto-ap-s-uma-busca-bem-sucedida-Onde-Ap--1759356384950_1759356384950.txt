âœ… CHECKLIST DE CORREÃ‡Ã•ES E MELHORIAS
ğŸ”§ 1. Salvar contexto apÃ³s uma busca bem-sucedida

ğŸ“ Onde: ApÃ³s a resposta da IA com produtos encontrados (backend).

âœ… AÃ§Ã£o:
No cÃ³digo que trata uma busca com sucesso, adicione:

await salvarContextoSessao(sessionId, {
  focoAtual: "iphone", // ou termo da busca atual
  categoriaAtual: "celular", // se conhecida
  ultimaQuery: searchTerm,
  ultimosModelos: ["15", "16"] // se modelos foram identificados
});


Isso garante que a prÃ³xima mensagem do usuÃ¡rio possa aproveitar esse histÃ³rico.

ğŸ§  2. Usar o contexto salvo quando entidades forem vazias

ğŸ“ Onde: No parser da nova mensagem (antes da busca).

âœ… AÃ§Ã£o:
Quando a extraÃ§Ã£o de entidades falhar, fazer algo como:

const contexto = await obterContextoSessao(sessionId);

if (!entities.models.length && /\b(13|14|15|16)\b/.test(searchTerm) && contexto?.focoAtual === "iphone") {
  entities.models.push(searchTerm.match(/\b(13|14|15|16)\b/)[0]);
  entities.brands.push("apple");
  entities.categories.push("celular");
}


ğŸ’¡ Isso resolve 100% do problema do "quero o modelo 13" depois de "iphone".

ğŸ” 3. Corrigir a extraÃ§Ã£o de entidade para aceitar nÃºmeros isolados

ğŸ“ Onde: No mÃ³dulo de parsing de entidades (provavelmente intents.ts ou outro mÃ³dulo de NLP).

âœ… AÃ§Ã£o:
Adicione um fallback para detectar modelos como nÃºmeros soltos:

const modelo = searchTerm.match(/\b\d{2}\b/); // Ex: "13", "14"
if (modelo) {
  entities.models.push(modelo[0]);
}


Mesmo sem marca, isso permite ao sistema tentar buscar pelo modelo.

ğŸ“‰ 4. Corrigir fallback do frontend (use-intelligent-search.ts)

ğŸ“ Onde: Dentro do useEffect que avalia clickProQuery.

âœ… AÃ§Ã£o:
Trocar de:

if (clickProQuery.isError || (clickProQuery.data && !clickProQuery.data.ok)) {
  setUseFallback(true);
}


Para:

if (
  clickProQuery.isError ||
  (clickProQuery.data && (!clickProQuery.data.ok || clickProQuery.data.products?.length === 0))
) {
  setUseFallback(true);
}


Assim o fallback Ã© ativado mesmo quando a IA responde â€œokâ€, mas sem produtos.

ğŸ—ƒï¸ 5. Verificar por que a sessÃ£o nÃ£o estÃ¡ sendo criada

ğŸ“ Onde: FunÃ§Ã£o que inicia a sessÃ£o (/api/assistant/sessions)

âœ… AÃ§Ã£o:
No log apareceu repetidamente:

âš ï¸ getConversationContext: No interactions found


Garanta que a sessÃ£o esteja realmente sendo criada e persistida no storage. SenÃ£o, obterContextoSessao(sessionId) sempre falharÃ¡. VocÃª pode fazer isso incluindo um log explÃ­cito:

console.log("SessÃ£o criada para:", sessionId)

âœ… Resultado Esperado ApÃ³s Aplicar o Checklist

Fluxo anterior (defeituoso):

UsuÃ¡rio: "iphone" â†’ IA retorna produtos
UsuÃ¡rio: "quero o modelo 13" â†’ IA responde: "nÃ£o encontrei nada"

Fluxo corrigido:

UsuÃ¡rio: "iphone" â†’ IA salva foco ("iphone", marca "apple", categoria "celular")
UsuÃ¡rio: "quero o modelo 13" â†’ IA reconhece como "iPhone 13" e retorna corretamente os produtos