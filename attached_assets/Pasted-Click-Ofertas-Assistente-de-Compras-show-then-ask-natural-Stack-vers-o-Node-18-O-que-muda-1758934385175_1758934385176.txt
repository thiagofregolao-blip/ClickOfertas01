Click Ofertas â€” Assistente de Compras (show-then-ask, natural)

Stack & versÃ£o: Node 18+

O que muda

Mostra primeiro (prefetch com o texto do usuÃ¡rio).

Chat curto, sem link/imagem, nunca lista produtos.

MÃ¡x 1 pergunta opcional apÃ³s exibir resultados.

Mensagens exatas abaixo usadas sÃ³ quando necessÃ¡rio (genÃ©rico/sem resultado/continuaÃ§Ã£o).

Ãrvore de diretÃ³rios
click-assistant/
â”œâ”€ src/
â”‚  â”œâ”€ server.js
â”‚  â”œâ”€ ai/
â”‚  â”‚  â”œâ”€ openai.js
â”‚  â”‚  â”œâ”€ chat.js
â”‚  â”‚  â””â”€ messages.js        # â† mensagens exatas (templates)
â”‚  â””â”€ services/
â”‚     â””â”€ catalog.js         # mock; troque pelo seu catÃ¡logo real
â”œâ”€ package.json
â”œâ”€ .replit
â””â”€ replit.nix

// package.json
{
  "name": "click-assistant",
  "version": "1.0.0",
  "type": "module",
  "main": "src/server.js",
  "scripts": {
    "start": "node src/server.js",
    "dev": "node --watch src/server.js",
    "test": "node -e \"console.log('ok')\""
  },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^4.19.2",
    "openai": "^4.56.0"
  }
}

# .replit
run = "npm install && npm run start"

# replit.nix
{ pkgs }: {
  deps = [ pkgs.nodejs-18_x pkgs.nodePackages.npm ];
}

// src/ai/openai.js
import OpenAI from "openai";
export const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// src/services/catalog.js
// ğŸ” TROQUE PELO SEU DB/API mantendo a assinatura de buscarOfertas({query,maxResultados})
const CATALOGO = [
  { id: "P1", titulo: "iPhone 13 128GB", preco: 980, loja: "Cell Shop", imagem: "#", link: "#" , marca:"Apple", categoria:"celulares"},
  { id: "P2", titulo: "iPhone 15 128GB", preco: 1199, loja: "Cell Shop", imagem: "#", link: "#", marca:"Apple", categoria:"celulares" },
  { id: "P3", titulo: "Perfume Dior Sauvage EDT 100ml", preco: 135, loja: "Cell Shop", imagem: "#", link: "#", marca:"Dior", categoria:"perfumes" },
  { id: "P4", titulo: "Drone DJI Mini 2", preco: 680, loja: "Shopping China", imagem:"#", link:"#", marca:"DJI", categoria:"drones" },
  { id: "P5", titulo: "iPhone 12 64GB", preco: 750, loja: "Atacado Store", imagem:"#", link:"#", marca:"Apple", categoria:"celulares" }
];

export async function buscarOfertas({ query, maxResultados = 12 } = {}) {
  const q = String(query || "").toLowerCase().trim();
  if (!q) return [];
  let arr = CATALOGO.filter(p =>
    p.titulo.toLowerCase().includes(q) ||
    (p.marca||"").toLowerCase().includes(q) ||
    (p.categoria||"").toLowerCase().includes(q)
  );
  arr.sort((a,b)=> a.preco - b.preco);
  return arr.slice(0, Math.max(1, Math.min(50, maxResultados)));
}

// src/ai/messages.js
// =============== MENSAGENS EXATAS (templates) =================

// 1) Quando a consulta Ã© genÃ©rica (ex.: â€œiphoneâ€, â€œperfumesâ€, â€œdroneâ€)
export function msgGenericFound(segmento) {
  return `Vejo que vocÃª estÃ¡ buscando ${segmento}. Listei alguns modelos abaixo. Me diga qual vocÃª quer! ğŸ˜‰`;
}

// 2) Quando encontrou itens especÃ­ficos (ex.: â€œiphone 13â€)
export function msgSpecificFound() {
  return "Achei opÃ§Ãµes e deixei nos resultados abaixo. Quer que eu refine por armazenamento/cor?";
}

// 3) Quando nÃ£o encontrou nada
export function msgNoResults() {
  return "NÃ£o achei itens com esse termo. Me diga o modelo exato para eu buscar certinho ğŸ™‚";
}

// 4) ContinuaÃ§Ã£o natural quando o usuÃ¡rio muda o foco (â€œquero o 13â€)
export function msgContextRefine(novoFoco) {
  return `Beleza! Foquei em ${novoFoco}. Se preferir, eu comparo duas opÃ§Ãµes lado a lado.`;
}

// 5) Pergunta leve (mÃ¡x 1) depois de mostrar â€“ opcional
export function msgSoftQuestion(tema) {
  // exemplos: "linha 13 ou 15", "compacto ou bateria forte"
  return `Prefere ${tema}? Posso ajustar os resultados.`;
}

// 6) SanitizaÃ§Ã£o de qualquer texto do modelo (garantia dupla no chat)
export function sanitizeChat(text = "") {
  return String(text)
    .replace(/!\[[^\]]*]\([^)]+\)/g, "")        // imagens
    .replace(/\[([^\]]+)]\(([^)]+)\)/g, "$1")   // links â†’ sÃ³ texto
    .replace(/https?:\/\/\S+/g, "")             // URLs cruas
    .replace(/\s{2,}/g, " ")
    .trim();
}

// 7) DeduÃ§Ãµes simples para frase genÃ©rica
export function segmentoDaQuery(query, ofertas=[]) {
  const q = (query||"").toLowerCase();
  const marcas = new Set(ofertas.map(o => (o.marca||"").toLowerCase()));
  const tem = (s) => q.includes(s) || [...marcas].some(m => m.includes(s));
  if (tem("iphone") || tem("apple")) return "aparelhos da Apple";
  if (tem("samsung") || tem("galaxy")) return "aparelhos Samsung";
  if (tem("drone")) return "drones";
  if (tem("perfume")) return "perfumes";
  return "esses produtos";
}

// src/ai/chat.js
/**
 * PolÃ­tica implementada:
 * - Prefetch sempre (mostra primeiro, pergunta depois).
 * - Chat curto (1â€“2 frases), sem links/imagens, NUNCA lista produtos.
 * - IA continua natural: usamos templates sÃ³ p/ manter experiÃªncia coesa.
 */
import { openai } from "./openai.js";
import { buscarOfertas } from "../services/catalog.js";
import {
  msgGenericFound, msgSpecificFound, msgNoResults, msgContextRefine,
  msgSoftQuestion, sanitizeChat, segmentoDaQuery
} from "./messages.js";

const SYSTEM_STYLE = `
VocÃª Ã© o Assistente de Compras do Click Ofertas.
Tom: natural, bem-humorado (1 emoji no mÃ¡x quando couber), direto ao ponto.
Regras:
- Mostre primeiro: nunca bloqueie a conversa pedindo cidade/preÃ§o. Pergunte sÃ³ se agregar valor e no mÃ¡x 1 pergunta.
- No chat: nÃ£o cole links/URLs/imagens; nÃ£o liste catÃ¡logos. A lista completa aparece no painel de resultados.
- Seja Ãºtil como um vendedor amigo: sugira comparaÃ§Ãµes, opÃ§Ãµes prÃ³ximas e dicas curtas.
`.trim();

export async function chatOnce({ message }) {
  const userQuery = String(message || "").trim();
  const messages = [
    { role: "system", content: SYSTEM_STYLE },
    { role: "user", content: userQuery }
  ];

  // 1) Mostra primeiro (prefetch com a prÃ³pria mensagem)
  const ofertas = userQuery ? await buscarOfertas({ query: userQuery, maxResultados: 12 }) : [];

  // 2) Decide mensagem â€œexataâ€ a partir do contexto
  let text;
  if (ofertas.length === 0) {
    text = msgNoResults();
  } else {
    // HeurÃ­stica simples: se a query tem 1â€“2 palavras => genÃ©rico; caso contrÃ¡rio especÃ­fico.
    const tokens = userQuery.split(/\s+/).filter(Boolean);
    if (tokens.length <= 2) {
      text = msgGenericFound(segmentoDaQuery(userQuery, ofertas));
    } else {
      text = msgSpecificFound();
    }
  }

  // 3) Pede ao modelo para lapidar o tom (sem permitir tool/refinamentos automÃ¡ticos)
  const polish = await openai.chat.completions.create({
    model: process.env.CHAT_MODEL || "gpt-4o-mini",
    temperature: 0.4,
    messages: [
      { role: "system", content: SYSTEM_STYLE },
      { role: "user", content: `Reescreva de forma natural e simpÃ¡tica, 1â€“2 frases no mÃ¡ximo, sem links/imagens: "${text}"` }
    ]
  });
  const polished = sanitizeChat(polish.choices?.[0]?.message?.content || text);

  // 4) (Opcional) 1 pergunta leve apÃ³s mostrar
  let pergunta = "";
  if (ofertas.length > 0) {
    // exemplos de temas â€“ ajuste se quiser
    if (/iphone|apple/i.test(userQuery)) pergunta = msgSoftQuestion("linha 13 ou 15");
    else if (/drone/i.test(userQuery))  pergunta = msgSoftQuestion("compacto ou cÃ¢mera mais parruda");
    else if (/perfume/i.test(userQuery)) pergunta = msgSoftQuestion("marcas favoritas (Dior, Calvin Klein...)");
  }
  const finalText = sanitizeChat([polished, pergunta].filter(Boolean).join(" "));

  // 5) Entrega: chat curto + ofertas para o painel
  return { text: finalText, ofertas };
}

// src/server.js
import express from "express";
import cors from "cors";
import { chatOnce } from "./ai/chat.js";

const app = express();
app.use(cors());
app.use(express.json({ limit: "1mb" }));

app.get("/health", (_req, res) => res.json({ ok: true }));

// POST /ai/chat { message } -> { text, ofertas[] }
app.post("/ai/chat", async (req, res) => {
  try {
    const { message } = req.body || {};
    if (!message || typeof message !== "string") return res.status(400).json({ error: "message obrigatÃ³rio" });
    const result = await chatOnce({ message });
    res.json(result);
  } catch (e) {
    console.error(e);
    res.status(500).json({ text: "Dei uma tropeÃ§ada aqui ğŸ¤¹ Tenta de novo?", ofertas: [] });
  }
});

// Demo rÃ¡pida
app.get("/", (_req, res) => {
  res.type("html").send(`
  <meta charset="utf-8" />
  <h3>Click Assistant â€” demo</h3>
  <input id="msg" style="width:420px" placeholder="ex.: iphone / drone / perfumes" />
  <button onclick="send()">Enviar</button>
  <pre id="out"></pre>
  <script>
  async function send(){
    const r = await fetch('/ai/chat',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message: document.getElementById('msg').value })});
    document.getElementById('out').textContent = JSON.stringify(await r.json(), null, 2);
  }
  </script>`);
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log("http://localhost:"+PORT));

â€œMensagens exatasâ€ (resumo, para vocÃª revisar/editar)

GenÃ©rico (iphone/drone/perfumes):
Vejo que vocÃª estÃ¡ buscando {segmento}. Listei alguns modelos abaixo. Me diga qual vocÃª quer! ğŸ˜‰

EspecÃ­fico (ex.: â€œiphone 13â€):
Achei opÃ§Ãµes e deixei nos resultados abaixo. Quer que eu refine por armazenamento/cor?

Sem resultado:
NÃ£o achei itens com esse termo. Me diga o modelo exato para eu buscar certinho ğŸ™‚

Refino por contexto (ex.: â€œquero o 13â€):
Beleza! Foquei em {novoFoco}. Se preferir, eu comparo duas opÃ§Ãµes lado a lado.

Pergunta leve (opcional, 1 por vez):

iPhone/Apple â†’ Prefere linha 13 ou 15? Posso ajustar os resultados.

Drone â†’ Prefere compacto ou cÃ¢mera mais parruda? Posso ajustar os resultados.

Perfume â†’ Quer que eu foque em marcas favoritas (Dior, Calvin Klein...)?

VocÃª pode editar todas no src/ai/messages.js sem tocar no resto do cÃ³digo.

Como rodar

No Replit: adicione os arquivos, crie Secret OPENAI_API_KEY.

Run.

Frontend chama POST /ai/chat com { message } e renderiza:

text no balÃ£o do chat,

ofertas[] no painel de produtos.