O que vou fazer (consenso)

Nunca perguntar cidade/preÃ§o.

Sempre buscar com o que o usuÃ¡rio digitou (prefetch).

Chat sem links e sem lista de produtos â€” sÃ³ uma frase curta tipo:
â€œVejo que vocÃª estÃ¡ buscando aparelhos da Apple. Listei alguns modelos abaixo. Me fale qual modelo vocÃª gostaria de comprar!â€

Se nÃ£o achar nada, o chat nÃ£o pergunta cidade/preÃ§o; sÃ³ pede o modelo exato.

Os produtos aparecem sÃ³ no bloco â€œResultados da Pesquisaâ€.

Abaixo estÃ¡ o patch final do src/ai/chat.js (substitui inteiro). Ele ignora qualquer tentativa do modelo de listar itens/links e sempre forÃ§a a frase curta.

// src/ai/chat.js â€” VERSÃƒO FINAL: sem perguntas, sem links, sem lista no chat
import OpenAI from "openai";
import { buscarOfertas } from "../services/catalog.js";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// Regras gerais (apenas estilo; a lÃ³gica decisiva estÃ¡ neste arquivo)
const SYSTEM_STYLE = `
VocÃª Ã© o Assistente do Click Ofertas.
- No chat: nunca escreva links/URLs, nem markdown de imagem (![]()) ou de link ([]()).
- NÃ£o invente produtos; use somente os retornados pela ferramenta.
`.trim();

// Tool mantida por compatibilidade; mas NÃƒO vamos deixar o modelo chamar.
const TOOLS = [
  {
    type: "function",
    function: {
      name: "buscarOfertas",
      description: "Busca ofertas por termo (query).",
      parameters: {
        type: "object",
        properties: {
          query: { type: "string" },
          maxResultados: { type: "integer", default: 12, minimum: 1, maximum: 50 }
        },
        required: ["query"]
      }
    }
  }
];

// Limpeza de links/markdown
function sanitizeChat(text = "") {
  return String(text)
    .replace(/!\[[^\]]*]\([^)]+\)/g, "")       // imagens
    .replace(/\[([^\]]+)]\(([^)]+)\)/g, "$1")  // links -> texto
    .replace(/https?:\/\/\S+/g, "")            // URLs cruas
    .replace(/\s{2,}/g, " ")
    .trim();
}

// Frase curta baseada no termo/brand
function fraseResumo(query, ofertas) {
  const q = (query || "").toLowerCase();
  const marcas = new Set((ofertas || []).map(o => (o.marca || "").toLowerCase()));
  const tem = (s) => q.includes(s) || [...marcas].some(m => m.includes(s));

  if (tem("iphone") || tem("apple")) return "aparelhos da Apple";
  if (tem("samsung") || tem("galaxy")) return "aparelhos Samsung";
  if (tem("drone")) return "drones";
  if (tem("perfume")) return "perfumes";
  return "esses produtos";
}

export async function chatOnce({ message }) {
  const userQuery = String(message || "").trim();
  const msgs = [
    { role: "system", content: SYSTEM_STYLE },
    { role: "user", content: userQuery }
  ];

  // 1) Busca PRÃ‰VIA *sempre* com o que o usuÃ¡rio digitou.
  let ofertas = [];
  if (userQuery.length >= 2) {
    ofertas = await buscarOfertas({ query: userQuery, maxResultados: 12 });
    // Injetamos para dar contexto ao modelo (mas NÃƒO permitimos novas tool calls).
    msgs.push({
      role: "tool",
      name: "buscarOfertas",
      tool_call_id: "prefetch",
      content: JSON.stringify({ data: ofertas })
    });
  }

  // 2) Pedimos uma resposta do modelo apenas para â€œtom de vozâ€.
  //    tool_choice: "none" impede que ele volte a perguntar cidade/preÃ§o.
  const resp = await openai.chat.completions.create({
    model: process.env.CHAT_MODEL || "gpt-4o-mini",
    temperature: 0.5,
    messages: msgs,
    tools: TOOLS,
    tool_choice: "none"
  });

  // 3) Ignoramos qualquer tentativa de listar itens/links e forÃ§amos a frase curta.
  let text = sanitizeChat(resp.choices?.[0]?.message?.content || "");

  if (ofertas.length > 0) {
    const alvo = fraseResumo(userQuery, ofertas);
    text = `Vejo que vocÃª estÃ¡ buscando ${alvo}. Listei alguns modelos abaixo. Me fale qual o modelo vocÃª gostaria de comprar!`;
    return { text, ofertas };
  }

  // 4) Sem resultados â†’ nada de cidade/preÃ§o.
  if (!text) {
    text = "NÃ£o encontrei itens com esse termo. Diga o nome exato do modelo que vocÃª quer ver ğŸ™‚";
  } else {
    // garante que nÃ£o haja listagem/links
    text = sanitizeChat(text);
  }
  return { text, ofertas: [] };
}

Por que agora funciona

Perguntas cortadas: tool_choice: "none" + retorno jÃ¡ com ofertas â†’ o modelo nÃ£o entra em â€œinterrogatÃ³rioâ€.

Sem lista/links no chat: ignoramos a resposta longa do modelo e sempre devolvemos a frase curta quando hÃ¡ produtos.

Resultados sempre no bloco de produtos: ofertas vem populado e vocÃª renderiza na grade.