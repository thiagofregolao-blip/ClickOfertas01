Perfeito â€” vamos deixar a IA nÃ£o perguntar nada quando o usuÃ¡rio digitar sÃ³ o nome genÃ©rico do produto (ex.: â€œiphoneâ€). Ela vai responder algo como:

â€œVejo que vocÃª estÃ¡ buscando aparelhos da Apple. Listei alguns modelos abaixo. Me fale qual modelo vocÃª gostaria de comprar!â€

Sem links/imagens no chat, e os produtos aparecem sÃ³ no bloco de resultados.

Aplique este patch do chat.js (substitui o arquivo atual):

// src/ai/chat.js â€” IA: genÃ©rico => sem perguntas, mensagem curta, sem links
import OpenAI from "openai";
import { buscarOfertas } from "../services/catalog.js";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// Frases por termo genÃ©rico (ajuste/adicione conforme seu catÃ¡logo)
const GENERICOS = [
  { rx: /\biphone?\b/i,   frase: "aparelhos da Apple" },
  { rx: /\b(apple)\b/i,   frase: "aparelhos da Apple" },
  { rx: /\bgalaxy|s2[3-5]\b/i, frase: "aparelhos Samsung" },
  { rx: /\bsamsung\b/i,   frase: "aparelhos Samsung" },
  { rx: /\bdrone[s]?\b/i, frase: "drones" },
  { rx: /\bperfume[s]?\b/i, frase: "perfumes" }
];

// Regra geral (continua valendo) â€” sem link/imagem no chat
const SYSTEM_STYLE = `
VocÃª Ã© o Assistente do Click Ofertas.
- No chat: nunca escreva links/URLs, nem markdown de imagem (![]()) ou de link ([]()).
- NÃ£o invente produtos; use somente os retornados pela ferramenta.
`.trim();

const TOOLS = [
  {
    type: "function",
    function: {
      name: "buscarOfertas",
      description: "Busca ofertas por termo (query). Retorna array de produtos do catÃ¡logo.",
      parameters: {
        type: "object",
        properties: {
          query: { type: "string", description: "termo de busca, ex.: 'iphone', 'drone', 'perfume'" },
          maxResultados: { type: "integer", default: 12, minimum: 1, maximum: 50 }
        },
        required: ["query"]
      }
    }
  }
];

function sanitizeChat(text = "") {
  return String(text)
    .replace(/!\[[^\]]*]\([^)]+\)/g, "")       // imagens markdown
    .replace(/\[([^\]]+)]\(([^)]+)\)/g, "$1")  // links markdown â†’ sÃ³ texto
    .replace(/https?:\/\/\S+/g, "")            // URLs cruas
    .replace(/\s{2,}/g, " ")
    .trim();
}

// Detecta se Ã© termo genÃ©rico (marca/categoria) â†’ devolve frase amigÃ¡vel
function detectarGenerico(msg) {
  const t = String(msg || "").trim();
  if (t.split(/\s+/).length > 4) return null; // frase grande: nÃ£o tratamos como genÃ©rico
  for (const g of GENERICOS) {
    if (g.rx.test(t)) return g.frase;
  }
  return null;
}

export async function chatOnce({ message }) {
  const userQuery = String(message || "").trim();
  const msgs = [
    { role: "system", content: SYSTEM_STYLE },
    { role: "user", content: userQuery }
  ];

  // 1) Se for termo genÃ©rico â†’ NÃƒO fazer perguntas, buscar direto e mandar mensagem padrÃ£o
  const fraseGenerica = detectarGenerico(userQuery);
  if (fraseGenerica) {
    const ofertas = await buscarOfertas({ query: userQuery, maxResultados: 12 });

    // Injeta como tool_result para o modelo â€œentenderâ€ os itens (sem listar/links)
    msgs.push({
      role: "tool",
      name: "buscarOfertas",
      tool_call_id: "prefetch",
      content: JSON.stringify({ data: ofertas })
    });

    // Chat curto e sem links
    const text =
      ofertas.length > 0
        ? `Vejo que vocÃª estÃ¡ buscando ${fraseGenerica}. Listei alguns modelos abaixo. Me fale qual o modelo vocÃª gostaria de comprar!`
        : `NÃ£o encontrei ${fraseGenerica} com esse termo. Pode me dizer o modelo exato que vocÃª quer ver?`;

    return { text, ofertas };
  }

  // 2) Caso NÃƒO seja genÃ©rico: padrÃ£o conversacional (modelo decide tool)
  const resp = await openai.chat.completions.create({
    model: process.env.CHAT_MODEL || "gpt-4o-mini",
    temperature: 0.5,
    messages: msgs,
    tools: TOOLS,
    tool_choice: "auto"
  });

  const m = resp.choices?.[0]?.message;
  const toolCalls = m?.tool_calls || [];

  if (toolCalls.length > 0) {
    for (const call of toolCalls) {
      if (call.type === "function" && call.function?.name === "buscarOfertas") {
        let args = {};
        try { args = JSON.parse(call.function.arguments || "{}"); } catch {}
        const produtos = await buscarOfertas(args);
        msgs.push({
          role: "tool",
          tool_call_id: call.id,
          name: "buscarOfertas",
          content: JSON.stringify({ data: produtos })
        });
    }
    // segunda passada para o modelo redigir
    const resp2 = await openai.chat.completions.create({
      model: process.env.CHAT_MODEL || "gpt-4o-mini",
      temperature: 0.5,
      messages: msgs,
      tools: TOOLS,
      tool_choice: "none"
    });
    const finalText = sanitizeChat(resp2.choices?.[0]?.message?.content || "");
    const lastTool = [...msgs].reverse().find(x => x.role === "tool" && x.name === "buscarOfertas");
    const ofertas = lastTool ? JSON.parse(lastTool.content).data : [];
    // Mantemos o chat curto se houver itens
    const text =
      ofertas.length > 0
        ? "Encontrei algumas opÃ§Ãµes e deixei nos resultados abaixo. Se quiser, diga o modelo exato para eu afinar ğŸ˜‰"
        : (finalText || "NÃ£o encontrei itens. Diga o nome exato do modelo que vocÃª quer ver ğŸ™‚");
    return { text, ofertas };
  }

  // Sem tool-calls â†’ sÃ³ responde (sanitizado). UI pode nÃ£o ter produtos.
  const fallbackText = sanitizeChat(m?.content?.trim() || "");
  return { text: fallbackText || "Me diga o nome do produto (ex.: 'iphone') que eu listo pra vocÃª!", ofertas: [] };
}

O que muda

Se o usuÃ¡rio digita apenas â€œiphoneâ€, â€œdroneâ€, â€œperfumesâ€â€¦:

Sem perguntas; busca direta;

Chat responde: â€œVejo que vocÃª estÃ¡ buscando â€¦ Listei alguns modelos abaixo. Me fale qual o modelo vocÃª gostaria de comprar!â€

Sem links/imagens no chat (sanitizaÃ§Ã£o).

Produtos aparecem apenas nos â€œResultados da Pesquisaâ€.

Para consultas mais especÃ­ficas (ex.: â€œiphone 13â€) o modelo ainda pode chamar a tool; mesmo assim, nÃ³s forÃ§amos resposta curta e sanitizada.

Ajustes que vocÃª pode fazer

Edite o array GENERICOS para cobrir mais termos/brands/categorias do seu catÃ¡logo.

Ajuste a frase do chat se quiser outro tom.