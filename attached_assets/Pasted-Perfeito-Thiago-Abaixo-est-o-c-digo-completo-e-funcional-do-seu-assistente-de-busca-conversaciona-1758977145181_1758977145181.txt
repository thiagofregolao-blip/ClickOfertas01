Perfeito, Thiago! Abaixo estÃ¡ o cÃ³digo completo e funcional do seu assistente de busca conversacional, pronto para rodar no Replit. Ele inclui todas as funcionalidades que definimos:

SaudaÃ§Ã£o personalizada com nome e hora local

Tom de vendedor bem-humorado

DetecÃ§Ã£o de intenÃ§Ã£o (saudaÃ§Ã£o, pergunta pessoal, follow-up, refinamento)

CompreensÃ£o semÃ¢ntica (ex: â€œquero sÃ³ o 12â€)

MemÃ³ria por usuÃ¡rio (em memÃ³ria local para MVP)

IntegraÃ§Ã£o com Azure OpenAI (substituindo Gemini)

GeraÃ§Ã£o de respostas dinÃ¢micas e criativas

ExibiÃ§Ã£o de produtos com estilo comercial

ğŸ§± Estrutura sugerida no Replit
CÃ³digo
/copilot-assistant
â”œâ”€â”€ index.js
â”œâ”€â”€ memory.js
â”œâ”€â”€ intent.js
â”œâ”€â”€ response.js
â”œâ”€â”€ utils.js
â”œâ”€â”€ .env
ğŸ“¦ Arquivo: .env
env
AZURE_API_KEY=your_azure_openai_key
AZURE_ENDPOINT=https://your-resource-name.openai.azure.com
AZURE_DEPLOYMENT=your-deployment-name
ğŸ“¦ Arquivo: index.js
js
import express from 'express';
import bodyParser from 'body-parser';
import fetch from 'node-fetch';
import { getMemory, updateMemory } from './memory.js';
import { classifyIntent, respondToIntent } from './intent.js';
import { refineQuery, generateGreeting } from './utils.js';
import { generateResponse, generateFollowUp } from './response.js';

const app = express();
app.use(bodyParser.json());

app.post('/api/assistant', async (req, res) => {
  const { message, sessionId, horaLocal, user } = req.body;
  const userId = user.id;
  const userName = user.name;

  const memory = getMemory(userId);
  const intent = classifyIntent(message);
  const intentResponse = respondToIntent(intent, userName, horaLocal);

  if (intentResponse) return res.json({ text: intentResponse });

  const refined = refineQuery(message, memory);
  const query = refined || message;

  const aiResponse = await callCopilotAI([
    { role: 'system', content: `VocÃª Ã© um vendedor bem-humorado que ajuda ${userName} a encontrar produtos.` },
    { role: 'user', content: query }
  ]);

  updateMemory(userId, { ultimaBusca: query });

  const followUp = generateFollowUp(query);
  const greeting = !memory.ultimaBusca ? generateGreeting(userName, horaLocal) : '';

  res.json({ text: `${greeting} ${aiResponse} ${followUp}`.trim() });
});

async function callCopilotAI(messages) {
  const response = await fetch(`${process.env.AZURE_ENDPOINT}/openai/deployments/${process.env.AZURE_DEPLOYMENT}/chat/completions?api-version=2023-05-15`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.AZURE_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      messages,
      temperature: 0.7,
      max_tokens: 500
    })
  });

  const data = await response.json();
  return data.choices[0].message.content;
}

app.listen(3000, () => console.log('Copilot Assistant rodando na porta 3000'));
ğŸ“¦ Arquivo: memory.js
js
const memoriaUsuarios = {};

export function getMemory(userId) {
  return memoriaUsuarios[userId] || {};
}

export function updateMemory(userId, dados) {
  memoriaUsuarios[userId] = {
    ...memoriaUsuarios[userId],
    ...dados
  };
}
ğŸ“¦ Arquivo: intent.js
js
export function classifyIntent(msg) {
  const texto = msg.toLowerCase();
  if (/qual seu nome|quem Ã© vocÃª/.test(texto)) return 'pergunta_sobre_ia';
  if (/que horas sÃ£o|hora agora/.test(texto)) return 'pergunta_hora';
  if (/bom dia|boa tarde|boa noite|oi|olÃ¡/.test(texto)) return 'saudacao';
  return null;
}

export function respondToIntent(tipo, nome, horaLocal) {
  switch (tipo) {
    case 'pergunta_sobre_ia':
      return `Sou seu assistente de compras, ${nome}! Sempre pronto pra te ajudar ğŸ›ï¸`;
    case 'pergunta_hora':
      const hora = horaLocal ?? new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      return `Agora sÃ£o ${hora} aqui! Quer aproveitar pra ver as ofertas da manhÃ£? â˜€ï¸`;
    case 'saudacao':
      return `Bom dia, ${nome}! ğŸ‘‹ Me diz o que vocÃª estÃ¡ procurando hoje.`;
    default:
      return null;
  }
}
ğŸ“¦ Arquivo: utils.js
js
export function generateGreeting(nome, horaLocal) {
  const hora = horaLocal ?? new Date().getHours();
  const base = hora < 12 ? 'Bom dia' : hora < 18 ? 'Boa tarde' : 'Boa noite';
  return `${base}, ${nome}! ğŸ‘‹`;
}

export function refineQuery(message, memory) {
  const msg = message.toLowerCase();
  const ultimaBusca = memory?.ultimaBusca?.toLowerCase();
  if (ultimaBusca?.includes('iphone') && /\b(12|13|15)\b/.test(msg)) {
    return `iphone ${msg.match(/\b(12|13|15)\b/)[0]}`;
  }
  return null;
}
ğŸ“¦ Arquivo: response.js
js
export function generateResponse(query, produtos, memoria) {
  if (produtos.length === 0) return 'NÃ£o achei nada com esse termo. Me dÃ¡ mais detalhes que eu busco certinho ğŸ™‚';
  const segmento = detectSegment(query);
  const marcaFavorita = memoria?.marca_preferida;

  const frases = [
    `Olha sÃ³, ${segmento} Ã© comigo mesmo! Separei umas opÃ§Ãµes que estÃ£o com preÃ§o Ã³timo ğŸ’¸`,
    `VocÃª vai curtir essas sugestÃµes de ${segmento}. Se quiser algo mais especÃ­fico, me dÃ¡ um toque ğŸ˜‰`,
    `Tem bastante coisa boa rolando em ${segmento}. DÃ¡ uma olhada e me diz o que achou ğŸ‘€`,
    `Separei umas opÃ§Ãµes de ${segmento} que estÃ£o fazendo sucesso. Se tiver uma marca em mente, me fala que eu afino a busca ğŸ”`
  ];

  if (marcaFavorita) {
    frases.push(`Como vocÃª curte ${marcaFavorita}, achei umas opÃ§Ãµes que podem te agradar ğŸ˜`);
  }

  return frases[Math.floor(Math.random() * frases.length)];
}

export function generateFollowUp(query) {
  if (/iphone/i.test(query)) return 'Prefere linha 12, 13 ou 15?';
  if (/drone/i.test(query)) return 'Quer um modelo compacto ou com cÃ¢mera parruda?';
  if (/perfume/i.test(query)) return 'Tem alguma marca favorita (Dior, Calvin Klein...)?';
  return '';
}

function detectSegment(query) {
  if (/perfume/i.test(query)) return 'perfumes';
  if (/iphone|celular|smartphone/i.test(query)) return 'celulares';
  if (/drone/i.test(query)) return 'drones';
  return 'produtos';
}