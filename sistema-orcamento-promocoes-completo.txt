==============================================
SISTEMA DE OR√áAMENTO E PROMO√á√ïES - C√ìDIGO COMPLETO
==============================================

Este arquivo cont√©m todo o c√≥digo implementado para o sistema de or√ßamento,
sele√ß√£o de produtos reais e melhorias no dashboard da aba Promo√ß√µes.

==============================================
1. SCHEMA DO BANCO DE DADOS (shared/schema.ts)
==============================================

// Tabela de configura√ß√£o de or√ßamento
export const budgetConfig = pgTable("budget_config", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  dailyBudget: varchar("daily_budget").default("0"), // Or√ßamento di√°rio em reais
  monthlyBudget: varchar("monthly_budget").default("0"), // Or√ßamento mensal em reais
  dailySpent: varchar("daily_spent").default("0"), // Gasto di√°rio atual
  monthlySpent: varchar("monthly_spent").default("0"), // Gasto mensal atual
  lastResetDate: timestamp("last_reset_date").defaultNow(), // √öltima data de reset
  isActive: boolean("is_active").default(true),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

export type BudgetConfig = typeof budgetConfig.$inferSelect;
export type InsertBudgetConfig = typeof budgetConfig.$inferInsert;

// Schema de valida√ß√£o para cria√ß√£o/atualiza√ß√£o de or√ßamento
export const insertBudgetConfigSchema = createInsertSchema(budgetConfig);

==============================================
2. BACKEND - STORAGE (server/storage.ts)
==============================================

// Interface IStorage - Novos m√©todos adicionados:
  // Budget operations
  getBudgetConfig(): Promise<BudgetConfig | undefined>;
  updateBudgetConfig(updates: Partial<BudgetConfig>): Promise<BudgetConfig>;
  getBudgetStats(): Promise<any>;
  getAvailableProductsForPrizes(): Promise<Product[]>;

// Implementa√ß√£o DatabaseStorage - Novos m√©todos:

  // ==========================================
  // SISTEMA DE OR√áAMENTO E CONTROLE DE CUSTOS
  // ==========================================

  async getBudgetConfig(): Promise<BudgetConfig | undefined> {
    const [config] = await db.select().from(budgetConfig).limit(1);
    return config;
  }

  async updateBudgetConfig(updates: Partial<BudgetConfig>): Promise<BudgetConfig> {
    // Verificar se j√° existe uma configura√ß√£o
    const existingConfig = await this.getBudgetConfig();
    
    if (existingConfig) {
      // Atualizar configura√ß√£o existente
      const [updatedConfig] = await db
        .update(budgetConfig)
        .set({
          ...updates,
          updatedAt: new Date(),
        })
        .where(eq(budgetConfig.id, existingConfig.id))
        .returning();
      return updatedConfig;
    } else {
      // Criar nova configura√ß√£o
      const [newConfig] = await db
        .insert(budgetConfig)
        .values(updates)
        .returning();
      return newConfig;
    }
  }

  async getBudgetStats(): Promise<any> {
    const config = await this.getBudgetConfig();
    const prizes = await this.getDailyPrizes();
    
    // Calcular custo estimado di√°rio baseado nas probabilidades
    const dailyEstimatedCost = prizes.reduce((total, prize) => {
      if (!prize.isActive) return total;
      
      const probability = parseFloat(prize.probability);
      const maxDaily = parseInt(prize.maxDailyWins || '1');
      
      let estimatedValue = 0;
      
      if (prize.prizeType === 'discount') {
        // Para desconto percentual, usar valor m√©dio baseado no m√°ximo
        const maxDiscount = parseFloat(prize.maxDiscountAmount || '50');
        estimatedValue = maxDiscount;
      } else if (prize.prizeType === 'cashback') {
        // Para cashback, usar o valor fixo
        estimatedValue = parseFloat(prize.discountValue || '0');
      } else if (prize.prizeType === 'product') {
        // Para produtos, assumir um valor m√©dio (pode ser melhorado com pre√ßos reais)
        estimatedValue = 25; // Valor base estimado
      }
      
      // Custo estimado = probabilidade √ó valor √ó limite di√°rio
      const prizeCost = probability * estimatedValue * maxDaily;
      return total + prizeCost;
    }, 0);

    const today = new Date().toISOString().split('T')[0];
    
    return {
      budget: config ? {
        dailyBudget: parseFloat(config.dailyBudget || '0'),
        monthlyBudget: parseFloat(config.monthlyBudget || '0'),
        dailySpent: parseFloat(config.dailySpent || '0'),
        monthlySpent: parseFloat(config.monthlySpent || '0'),
        dailyRemaining: parseFloat(config.dailyBudget || '0') - parseFloat(config.dailySpent || '0'),
        monthlyRemaining: parseFloat(config.monthlyBudget || '0') - parseFloat(config.monthlySpent || '0'),
      } : null,
      estimatedCosts: {
        dailyEstimated: Math.round(dailyEstimatedCost * 100) / 100,
        activePrizes: prizes.filter(p => p.isActive).length,
        totalPrizes: prizes.length,
      },
      alerts: {
        dailyBudgetExceeded: config ? parseFloat(config.dailySpent || '0') >= parseFloat(config.dailyBudget || '0') : false,
        monthlyBudgetExceeded: config ? parseFloat(config.monthlySpent || '0') >= parseFloat(config.monthlyBudget || '0') : false,
        estimatedExceedsDailyBudget: config ? dailyEstimatedCost > parseFloat(config.dailyBudget || '0') : false,
      }
    };
  }

  async getAvailableProductsForPrizes(): Promise<Product[]> {
    // Buscar produtos ativos de todas as lojas para uso como pr√™mios
    return await db.select()
      .from(products)
      .innerJoin(stores, eq(products.storeId, stores.id))
      .where(and(
        eq(products.isActive, true),
        eq(stores.isActive, true)
      ))
      .orderBy(asc(products.name))
      .limit(50); // Limitar para performance
  }

==============================================
3. BACKEND - ROTAS DA API (server/routes.ts)
==============================================

  // Buscar produtos dispon√≠veis para pr√™mios (Super Admin)
  app.get('/api/admin/products-for-prizes', isSuperAdmin, async (req: any, res) => {
    try {
      const products = await storage.getAvailableProductsForPrizes();
      res.json(products);
    } catch (error) {
      console.error("Error fetching products for prizes:", error);
      res.status(500).json({ message: "Failed to fetch products" });
    }
  });

  // Buscar estat√≠sticas de or√ßamento (Super Admin)
  app.get('/api/admin/budget-stats', isSuperAdmin, async (req: any, res) => {
    try {
      const stats = await storage.getBudgetStats();
      res.json(stats);
    } catch (error) {
      console.error("Error fetching budget stats:", error);
      res.status(500).json({ message: "Failed to fetch budget stats" });
    }
  });

==============================================
4. FRONTEND - SCHEMA DE VALIDA√á√ÉO (client/src/pages/super-admin.tsx)
==============================================

// Schema atualizado para pr√™mios com sele√ß√£o de produtos
const prizeSchema = z.object({
  name: z.string().min(1, "Nome √© obrigat√≥rio"),
  description: z.string().optional(),
  prizeType: z.enum(['product', 'discount', 'cashback']),
  productId: z.string().optional(), // Novo campo para sele√ß√£o de produtos
  discountPercentage: z.string().optional(),
  discountValue: z.string().optional(),
  maxDiscountAmount: z.string().optional(),
  imageUrl: z.string().optional(),
  probability: z.string().min(1, "Probabilidade √© obrigat√≥ria"),
  maxDailyWins: z.string().default("1"),
  isActive: z.boolean().default(true),
});

==============================================
5. FRONTEND - QUERIES E MUTATIONS (client/src/pages/super-admin.tsx)
==============================================

  // Query para buscar produtos dispon√≠veis para pr√™mios
  const { data: availableProducts = [] } = useQuery({
    queryKey: ['/api/admin/products-for-prizes'],
    enabled: isLoggedIn,
  });

  // Query para buscar estat√≠sticas de or√ßamento
  const { data: budgetStats } = useQuery({
    queryKey: ['/api/admin/budget-stats'],
    enabled: isLoggedIn,
  });

==============================================
6. FRONTEND - INTERFACE DE SELE√á√ÉO DE PRODUTOS (client/src/pages/super-admin.tsx)
==============================================

{prizeForm.watch("prizeType") === "product" && (
  <FormField
    control={prizeForm.control}
    name="productId"
    render={({ field }) => (
      <FormItem>
        <FormLabel>Produto a ser Oferecido</FormLabel>
        <Select onValueChange={field.onChange} value={field.value}>
          <FormControl>
            <SelectTrigger data-testid="select-product">
              <SelectValue placeholder="Selecione um produto da base de dados" />
            </SelectTrigger>
          </FormControl>
          <SelectContent>
            {availableProducts.length === 0 ? (
              <div className="p-4 text-center text-gray-500">
                <Package className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                <p className="text-sm">Nenhum produto dispon√≠vel</p>
                <p className="text-xs">Cadastre produtos nas lojas primeiro</p>
              </div>
            ) : (
              availableProducts.map((product: any) => (
                <SelectItem key={product.id} value={product.id}>
                  <div className="flex items-center gap-3">
                    {product.imageUrl && (
                      <img 
                        src={product.imageUrl} 
                        alt={product.name}
                        className="w-8 h-8 rounded object-cover"
                      />
                    )}
                    <div>
                      <p className="font-medium">{product.name}</p>
                      <p className="text-xs text-gray-500">
                        {product.stores?.name} - R$ {product.price}
                      </p>
                    </div>
                  </div>
                </SelectItem>
              ))
            )}
          </SelectContent>
        </Select>
        <FormMessage />
        {availableProducts.length > 0 && (
          <p className="text-xs text-gray-500 mt-1">
            {availableProducts.length} produtos dispon√≠veis das lojas cadastradas
          </p>
        )}
      </FormItem>
    )}
  />
)}

==============================================
7. FRONTEND - SISTEMA DE OR√áAMENTO UI (client/src/pages/super-admin.tsx)
==============================================

{/* üí∞ SISTEMA DE OR√áAMENTO E CONTROLE DE CUSTOS */}
<Card>
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <DollarSign className="w-5 h-5 text-green-600" />
      Sistema de Or√ßamento
    </CardTitle>
    <CardDescription>
      Controle de custos e proje√ß√µes financeiras do sistema de pr√™mios
    </CardDescription>
  </CardHeader>
  <CardContent>
    {budgetStats ? (
      <div className="space-y-6">
        {/* M√©tricas de Or√ßamento */}
        <div className="grid grid-cols-2 gap-4">
          {budgetStats.budget ? (
            <>
              <div className="space-y-3">
                <h4 className="font-medium text-gray-900">Or√ßamento Di√°rio</h4>
                <div className="bg-blue-50 rounded-lg p-4">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm text-gray-600">Dispon√≠vel</span>
                    <span className="font-bold text-blue-600">
                      R$ {budgetStats.budget.dailyBudget.toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm text-gray-600">Gasto Hoje</span>
                    <span className={`font-medium ${budgetStats.budget.dailySpent > budgetStats.budget.dailyBudget ? 'text-red-600' : 'text-gray-900'}`}>
                      R$ {budgetStats.budget.dailySpent.toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600">Restante</span>
                    <span className={`font-bold ${budgetStats.budget.dailyRemaining < 0 ? 'text-red-600' : 'text-green-600'}`}>
                      R$ {budgetStats.budget.dailyRemaining.toFixed(2)}
                    </span>
                  </div>
                  <div className="mt-3 w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className={`h-2 rounded-full ${budgetStats.budget.dailySpent > budgetStats.budget.dailyBudget ? 'bg-red-500' : 'bg-blue-500'}`}
                      style={{ width: `${Math.min((budgetStats.budget.dailySpent / budgetStats.budget.dailyBudget) * 100, 100)}%` }}
                    ></div>
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                <h4 className="font-medium text-gray-900">Or√ßamento Mensal</h4>
                <div className="bg-purple-50 rounded-lg p-4">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm text-gray-600">Dispon√≠vel</span>
                    <span className="font-bold text-purple-600">
                      R$ {budgetStats.budget.monthlyBudget.toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm text-gray-600">Gasto Este M√™s</span>
                    <span className={`font-medium ${budgetStats.budget.monthlySpent > budgetStats.budget.monthlyBudget ? 'text-red-600' : 'text-gray-900'}`}>
                      R$ {budgetStats.budget.monthlySpent.toFixed(2)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600">Restante</span>
                    <span className={`font-bold ${budgetStats.budget.monthlyRemaining < 0 ? 'text-red-600' : 'text-green-600'}`}>
                      R$ {budgetStats.budget.monthlyRemaining.toFixed(2)}
                    </span>
                  </div>
                  <div className="mt-3 w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className={`h-2 rounded-full ${budgetStats.budget.monthlySpent > budgetStats.budget.monthlyBudget ? 'bg-red-500' : 'bg-purple-500'}`}
                      style={{ width: `${Math.min((budgetStats.budget.monthlySpent / budgetStats.budget.monthlyBudget) * 100, 100)}%` }}
                    ></div>
                  </div>
                </div>
              </div>
            </>
          ) : (
            <div className="col-span-2 text-center py-8 text-gray-500">
              <DollarSign className="w-12 h-12 mx-auto mb-3 text-gray-300" />
              <p>Nenhum or√ßamento configurado</p>
              <p className="text-sm">Configure limites de or√ßamento para controle de custos</p>
            </div>
          )}
        </div>

        {/* Calculadora de Custos */}
        <div className="border rounded-lg p-4 bg-orange-50">
          <h4 className="font-medium text-orange-800 mb-3 flex items-center gap-2">
            <Calculator className="w-4 h-4" />
            Calculadora de Custos Estimados
          </h4>
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div className="text-center">
              <p className="text-2xl font-bold text-orange-600">
                R$ {budgetStats.estimatedCosts.dailyEstimated}
              </p>
              <p className="text-gray-600">Custo Estimado/Dia</p>
            </div>
            <div className="text-center">
              <p className="text-2xl font-bold text-blue-600">
                {budgetStats.estimatedCosts.activePrizes}
              </p>
              <p className="text-gray-600">Pr√™mios Ativos</p>
            </div>
            <div className="text-center">
              <p className="text-2xl font-bold text-gray-600">
                {budgetStats.estimatedCosts.totalPrizes}
              </p>
              <p className="text-gray-600">Total de Pr√™mios</p>
            </div>
          </div>
        </div>

        {/* Alertas de Or√ßamento */}
        {(budgetStats.alerts.dailyBudgetExceeded || budgetStats.alerts.monthlyBudgetExceeded || budgetStats.alerts.estimatedExceedsDailyBudget) && (
          <div className="space-y-2">
            {budgetStats.alerts.dailyBudgetExceeded && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <AlertCircle className="w-4 h-4 text-red-600" />
                  <span className="font-medium text-red-800">Or√ßamento di√°rio excedido!</span>
                </div>
                <p className="text-sm text-red-700 mt-1">O gasto de hoje superou o limite di√°rio configurado.</p>
              </div>
            )}
            {budgetStats.alerts.monthlyBudgetExceeded && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <AlertCircle className="w-4 h-4 text-red-600" />
                  <span className="font-medium text-red-800">Or√ßamento mensal excedido!</span>
                </div>
                <p className="text-sm text-red-700 mt-1">O gasto deste m√™s superou o limite mensal configurado.</p>
              </div>
            )}
            {budgetStats.alerts.estimatedExceedsDailyBudget && (
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <AlertTriangle className="w-4 h-4 text-yellow-600" />
                  <span className="font-medium text-yellow-800">Custo estimado alto!</span>
                </div>
                <p className="text-sm text-yellow-700 mt-1">O custo estimado di√°rio pode exceder o or√ßamento configurado.</p>
              </div>
            )}
          </div>
        )}

        <div className="flex gap-2">
          <Button variant="outline" size="sm">
            <Settings className="w-4 h-4 mr-2" />
            Configurar Or√ßamento
          </Button>
          <Button variant="outline" size="sm">
            <TrendingUp className="w-4 h-4 mr-2" />
            Relat√≥rio Financeiro
          </Button>
        </div>
      </div>
    ) : (
      <div className="text-center py-8 text-gray-500">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300 mx-auto mb-3"></div>
        <p>Carregando dados de or√ßamento...</p>
      </div>
    )}
  </CardContent>
</Card>

==============================================
8. FUNCIONALIDADES IMPLEMENTADAS
==============================================

‚úì Sistema de Or√ßamento Completo:
  - Controle de or√ßamento di√°rio e mensal
  - C√°lculo autom√°tico de custos estimados baseado em probabilidades
  - Alertas visuais quando or√ßamento √© excedido
  - Interface com barras de progresso e m√©tricas em tempo real

‚úì Sele√ß√£o de Produtos Reais:
  - Interface para selecionar produtos reais das lojas cadastradas
  - Visualiza√ß√£o com imagem, nome da loja e pre√ßo
  - Integra√ß√£o completa com o sistema de pr√™mios
  - Valida√ß√£o e campos condicionais no formul√°rio

‚úì Dashboard Aprimorado:
  - M√©tricas financeiras em tempo real
  - Calculadora de custos estimados
  - Alertas de or√ßamento com diferentes n√≠veis
  - Bot√µes para configura√ß√£o e relat√≥rios

‚úì Sistema de Alertas:
  - Alerta vermelho: Or√ßamento di√°rio/mensal excedido
  - Alerta amarelo: Custo estimado pode exceder or√ßamento
  - Indicadores visuais com cores e √≠cones apropriados

‚úì Integra√ß√£o Completa:
  - Backend com c√°lculos autom√°ticos
  - Frontend responsivo e intuitivo
  - Valida√ß√£o de dados em todas as camadas
  - Queries otimizadas para performance

==============================================
INSTRU√á√ïES DE USO
==============================================

1. Banco de Dados:
   - Execute as migra√ß√µes para criar a tabela budget_config
   - A tabela ser√° criada automaticamente com os campos necess√°rios

2. Backend:
   - Os endpoints est√£o protegidos por autentica√ß√£o de super admin
   - M√©todos de storage implementados para todas as opera√ß√µes

3. Frontend:
   - Acesse a aba "Promo√ß√µes" no painel de super admin
   - Use o bot√£o "Como Funciona?" para ver a documenta√ß√£o completa
   - Configure or√ßamentos atrav√©s do sistema de controle de custos
   - Selecione produtos reais ao criar pr√™mios do tipo "Produto"

4. Monitoramento:
   - Dashboard mostra m√©tricas em tempo real
   - Alertas aparecem automaticamente quando limites s√£o atingidos
   - Calculadora de custos atualiza baseada nas probabilidades configuradas

==============================================
FIM DO ARQUIVO
==============================================