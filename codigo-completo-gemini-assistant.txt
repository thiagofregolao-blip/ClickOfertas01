=== C√ìDIGO COMPLETO DO GEMINI ASSISTANT - VERS√ÉO ATUALIZADA ===
=== Click Ofertas Paraguai - IA Ask-Then-Show com Melhorias ===

Este arquivo cont√©m todo o c√≥digo atualizado do assistente Gemini com interpreta√ß√£o sem√¢ntica avan√ßada,
compara√ß√£o de produtos, fluxos conversacionais e filosofia "Ask-Then-Show".

========================================
1. BACKEND - ENDPOINT PRINCIPAL ATUALIZADO
========================================

// server/routes.ts - Endpoint POST /api/assistant/gemini/stream
app.post('/api/assistant/gemini/stream', async (req: any, res) => {
  const { message, sessionId, horaLocal } = req.body;
  const user = req.user || req.session?.user;
  const userName = user?.name || 'cliente';
  const userId = user?.id;

  res.setHeader('Content-Type', 'text/event-stream; charset=utf-8');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.flushHeaders?.();

  const send = (event: string, payload: any) => {
    res.write(`event: ${event}\n`);
    res.write(`data: ${JSON.stringify(payload)}\n\n`);
  };

  try {
    // Importar m√≥dulos
    const { buscarOfertas } = await import('./lib/gemini/busca.js');
    const { persistSessionAndMessage, getSessionMessages, salvarResposta } = await import('./lib/gemini/session.js');
    const { gerarSaudacao, saudacaoInicial, classificarIntencao, responderPorIntencao, interpretarRefinamento, detectarIntencaoFollowUp, responderFollowUp, gerarRespostaConversacional, gerarPerguntaLeve, gerarFollowUp } = await import('./lib/gemini/respostas.js');
    const { detectarComparacao, extrairModelosComparacao, gerarComparacao } = await import('./lib/gemini/comparador.js');

    await persistSessionAndMessage(sessionId, userId, message);
    const mensagens = await getSessionMessages(sessionId);
    const memoria = memoriaUsuarios[userId] || {};

    // Classifica√ß√£o de inten√ß√£o
    const tipoIntencao = classificarIntencao(message);
    const respostaIntencao = responderPorIntencao(tipoIntencao, userName, horaLocal);
    if (respostaIntencao) {
      send('delta', { text: respostaIntencao });
      send('complete', { provider: 'gemini' });
      return res.end();
    }

    // Follow-up inteligente
    const intencao = detectarIntencaoFollowUp(message);
    if (intencao) {
      const resposta = responderFollowUp(intencao);
      send('delta', { text: resposta });
      send('complete', { provider: 'gemini' });
      return res.end();
    }

    // Detec√ß√£o de compara√ß√£o de produtos
    if (detectarComparacao(message)) {
      const modelos = extrairModelosComparacao(message);
      const comparacao = gerarComparacao(modelos);
      send('delta', { text: comparacao });
      send('complete', { provider: 'gemini' });
      return res.end();
    }

    // Refinamento sem√¢ntico
    const refinamento = interpretarRefinamento(message, memoria);
    const contexto = mensagens.map((m: any) => m.content).join(' | ');
    const finalQuery = refinamento || (message.length < 4 ? `${contexto} ${message}` : message);

    // Buscar produtos
    const produtos = await buscarOfertas({ query: finalQuery });
    
    // Atualizar mem√≥ria
    memoriaUsuarios[userId] = {
      ...memoria,
      ultimaBusca: finalQuery,
      produtosVistos: produtos.map((p: any) => p.id),
    };

    // Gerar resposta
    const saudacao = mensagens.length <= 1 ? gerarSaudacao(userName, horaLocal) : '';
    const resposta = gerarRespostaConversacional(finalQuery, produtos, memoriaUsuarios[userId]);
    const pergunta = gerarFollowUp(finalQuery);

    const textoFinal = [saudacao, resposta, pergunta].filter(Boolean).join(' ');
    send('delta', { text: textoFinal });

    // Aguardar um pouco para a conversa aparecer primeiro
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Depois enviar produtos se houver (Ask-Then-Show)
    if (produtos.length > 0) {
      send('products', { products: produtos, query: finalQuery, provider: 'gemini' });
    }

    await salvarResposta(sessionId, textoFinal);
    send('complete', { provider: 'gemini' });
    res.end();
  } catch (error) {
    console.error('Erro no chat Gemini:', error);
    send('delta', { text: "Me diga o nome do produto (ex.: 'iphone') que eu listo pra voc√™!" });
    send('complete', { provider: 'gemini' });
    res.end();
  }
});

========================================
2. M√ìDULO DE RESPOSTAS - INTERPRETA√á√ÉO SEM√ÇNTICA AVAN√áADA
========================================

// server/lib/gemini/respostas.ts
export function gerarSaudacao(nome: string, horaLocal?: number) {
  const hora = horaLocal ?? new Date().getHours();
  const base = hora < 12 ? 'Bom dia' : hora < 18 ? 'Boa tarde' : 'Boa noite';
  return `${base}, ${nome}! üëã`;
}

export function saudacaoInicial(mensagens: any[]) {
  return mensagens.length <= 1;
}

export function classificarIntencao(msg: string) {
  const texto = msg.toLowerCase();
  if (/qual seu nome|quem √© voc√™|quem est√° falando/.test(texto)) return 'pergunta_sobre_ia';
  if (/que horas s√£o|hora agora/.test(texto)) return 'pergunta_hora';
  if (/^(bom dia|boa tarde|boa noite|oi|ol√°)$/i.test(texto.trim())) return 'saudacao';
  return null;
}

export function responderPorIntencao(tipo: string | null, nome: string, horaLocal?: number) {
  switch (tipo) {
    case 'pergunta_sobre_ia':
      return `Sou seu assistente de compras, ${nome}! Sempre pronto pra te ajudar a encontrar o que quiser üõçÔ∏è`;
    case 'pergunta_hora':
      const hora = horaLocal ? `${horaLocal}:00` : new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      return `Agora s√£o ${hora} aqui! Quer aproveitar pra ver as ofertas da manh√£? ‚òÄÔ∏è`;
    case 'saudacao':
      return `${gerarSaudacao(nome, horaLocal)} Me diz o que voc√™ est√° procurando hoje.`;
    default:
      return null;
  }
}

// *** INTERPRETA√á√ÉO SEM√ÇNTICA AVAN√áADA - CORA√á√ÉO DO SISTEMA ***
export function interpretarFraseProduto(msg: string, memoria: any) {
  const texto = msg.toLowerCase();

  const produto = /\b(iphone|galaxy|drone|perfume|notebook|laptop|celular|smartphone|tablet|fone|mouse|teclado|monitor|tv|smartwatch|airpods)\b/.exec(texto)?.[0];
  const modelo = /\b(12|13|14|15|16|s22|s23|s24|128gb|256gb|512gb|1tb|pro|max|mini|se|plus|ultra)\b/.exec(texto)?.[0];
  const marca = /\b(apple|samsung|xiaomi|dior|calvin klein|lg|motorola|dell|asus|nike|adidas|sony|hp|lenovo|acer)\b/.exec(texto)?.[0];
  const tipo = /\b(masculino|feminino|compacto|potente|boa c√¢mera|c√¢mera|bateria|barato|caro|novo|usado|original|importado|nacional|gamer|profissional|b√°sico)\b/.exec(texto)?.[0];

  let query = '';
  if (produto) query += produto;
  if (modelo) query += ` ${modelo}`;
  if (marca) query += ` ${marca}`;
  if (tipo) query += ` ${tipo}`;

  // fallback: usar √∫ltima busca se n√£o tiver produto expl√≠cito
  if (!produto && memoria?.ultimaBusca) query = `${memoria.ultimaBusca} ${texto}`;

  return query.trim() || null;
}

export function interpretarRefinamento(message: string, memoria: any) {
  // Usar nova fun√ß√£o sem√¢ntica primeiro
  const querySemantica = interpretarFraseProduto(message, memoria);
  if (querySemantica) return querySemantica;
  
  // Fallback para l√≥gica antiga
  const msg = message.toLowerCase();
  const ultimaBusca = memoria?.ultimaBusca?.toLowerCase();
  if (ultimaBusca?.includes('iphone') && /\b(12|13|15)\b/.test(msg)) {
    return `iphone ${msg.match(/\b(12|13|15)\b/)![0]}`;
  }
  return null;
}

export function detectarIntencaoFollowUp(msg: string) {
  const m = msg.toLowerCase();
  if (m.includes('gostei') || m.includes('quero esse')) return 'confirmar';
  if (m.includes('n√£o gostei') || m.includes('mostra outros')) return 'rejeitar';
  if (m.includes('128gb') || m.includes('mais barato')) return 'refinar';
  return null;
}

export function responderFollowUp(tipo: string) {
  switch (tipo) {
    case 'confirmar': return '√ìtima escolha! Posso te ajudar a finalizar ou mostrar acess√≥rios üõçÔ∏è';
    case 'rejeitar': return 'Sem problemas! Vou buscar outras op√ß√µes que talvez te agradem mais üîÑ';
    case 'refinar': return 'Entendi! Vou ajustar a busca com base no que voc√™ quer üîç';
    default: return 'Se quiser refinar ou ver mais, √© s√≥ me dizer üòâ';
  }
}

export function gerarRespostaConversacional(query: string, produtos: any[], memoria: any) {
  if (produtos.length === 0) return 'N√£o achei nada com esse termo. Me d√° mais detalhes que eu busco certinho üôÇ';
  const segmento = detectarSegmento(query);
  const marcaFavorita = memoria?.marca_preferida;

  const frases = [
    `Olha s√≥, ${segmento} √© comigo mesmo! Separei umas op√ß√µes que est√£o com pre√ßo √≥timo üí∏`,
    `Voc√™ vai curtir essas sugest√µes de ${segmento}. Se quiser algo mais espec√≠fico, me d√° um toque üòâ`,
    `Tem bastante coisa boa rolando em ${segmento}. D√° uma olhada e me diz o que achou üëÄ`,
    `Separei umas op√ß√µes de ${segmento} que est√£o fazendo sucesso. Se tiver uma marca em mente, me fala que eu afino a busca üîç`
  ];

  if (marcaFavorita) {
    frases.push(`Como voc√™ curte ${marcaFavorita}, achei umas op√ß√µes que podem te agradar üòé`);
  }

  return frases[Math.floor(Math.random() * frases.length)];
}

export function gerarPerguntaLeve(query: string) {
  if (/iphone/i.test(query)) return 'Prefere linha 12, 13 ou 15?';
  if (/drone/i.test(query)) return 'Quer um modelo compacto ou com c√¢mera parruda?';
  if (/perfume/i.test(query)) return 'Tem alguma marca favorita (Dior, Calvin Klein...)?';
  if (/notebook|laptop/i.test(query)) return 'Quer um modelo gamer, profissional ou b√°sico?';
  return '';
}

export function gerarFollowUp(query: string) {
  if (/iphone/i.test(query)) return 'Prefere linha 12, 13 ou 15?';
  if (/drone/i.test(query)) return 'Quer um modelo compacto ou com c√¢mera parruda?';
  if (/perfume/i.test(query)) return 'Tem alguma marca favorita (Dior, Calvin Klein...)?';
  if (/notebook|laptop/i.test(query)) return 'Quer um modelo gamer, profissional ou b√°sico?';
  return '';
}

function detectarSegmento(query: string) {
  if (/perfume/i.test(query)) return 'perfumes';
  if (/iphone|celular|smartphone/i.test(query)) return 'celulares';
  if (/drone/i.test(query)) return 'drones';
  if (/notebook|laptop/i.test(query)) return 'notebooks';
  return 'produtos';
}

========================================
3. NOVO M√ìDULO DE COMPARA√á√ÉO DE PRODUTOS
========================================

// server/lib/gemini/comparador.ts
const produtosCatalogo: Record<string, any> = {
  'iphone 12': {
    modelo: 'iPhone 12',
    chip: 'A14 Bionic',
    camera: 'Dupla 12MP',
    tela: 'OLED 6.1"',
    preco: 450
  },
  'iphone 13': {
    modelo: 'iPhone 13',
    chip: 'A15 Bionic',
    camera: 'Dupla 12MP com estabiliza√ß√£o',
    tela: 'OLED 6.1"',
    preco: 500
  },
  'iphone 14': {
    modelo: 'iPhone 14',
    chip: 'A15 Bionic',
    camera: 'Dupla 12MP avan√ßada',
    tela: 'OLED 6.1"',
    preco: 580
  },
  'iphone 15': {
    modelo: 'iPhone 15',
    chip: 'A16 Bionic',
    camera: 'Tripla 48MP',
    tela: 'OLED 6.1" ProMotion',
    preco: 650
  },
  'iphone 16': {
    modelo: 'iPhone 16',
    chip: 'A17 Pro',
    camera: 'Tripla 48MP + IA',
    tela: 'OLED 6.1" ProMotion 120Hz',
    preco: 750
  },
  'galaxy s22': {
    modelo: 'Galaxy S22',
    chip: 'Snapdragon 8 Gen 1',
    camera: 'Tripla 50MP',
    tela: 'AMOLED 6.1" 120Hz',
    preco: 400
  },
  'galaxy s23': {
    modelo: 'Galaxy S23',
    chip: 'Snapdragon 8 Gen 2',
    camera: 'Tripla 50MP melhorada',
    tela: 'AMOLED 6.1" 120Hz',
    preco: 480
  },
  'galaxy s24': {
    modelo: 'Galaxy S24',
    chip: 'Snapdragon 8 Gen 3',
    camera: 'Tripla 50MP + IA',
    tela: 'AMOLED 6.2" 120Hz',
    preco: 550
  }
};

export function detectarComparacao(msg: string) {
  return /\b(versus|vs|comparar|diferen√ßa entre|qual melhor|compare)\b/.test(msg.toLowerCase());
}

export function extrairModelosComparacao(msg: string) {
  const modelos: string[] = [];
  const texto = msg.toLowerCase();
  
  // Buscar iPhones
  ['12', '13', '14', '15', '16'].forEach(num => {
    if (texto.includes(num) && (texto.includes('iphone') || texto.includes('linha'))) {
      modelos.push(`iphone ${num}`);
    }
  });
  
  // Buscar Galaxy
  ['s22', 's23', 's24'].forEach(modelo => {
    if (texto.includes(modelo)) {
      modelos.push(`galaxy ${modelo}`);
    }
  });
  
  return modelos;
}

export function gerarComparacao(modelos: string[]) {
  if (modelos.length < 2) return 'Me diga dois modelos que voc√™ quer comparar üòâ';

  const [m1, m2] = modelos;
  const p1 = produtosCatalogo[m1];
  const p2 = produtosCatalogo[m2];

  if (!p1 || !p2) return 'N√£o encontrei dados suficientes para comparar esses modelos üòï';

  return `üì± Comparando ${p1.modelo} vs ${p2.modelo}:\n\n` +
    `‚Ä¢ Chip: ${p1.chip} vs ${p2.chip}\n` +
    `‚Ä¢ C√¢mera: ${p1.camera} vs ${p2.camera}\n` +
    `‚Ä¢ Tela: ${p1.tela} vs ${p2.tela}\n` +
    `‚Ä¢ Pre√ßo estimado: $${p1.preco} vs $${p2.preco}\n\n` +
    `Me diz qual te interessou mais que eu te mostro as ofertas! üî•`;
}

========================================
4. M√ìDULO DE BUSCA DE PRODUTOS
========================================

// server/lib/gemini/busca.ts
export async function buscarOfertas(args: { query: string; maxResultados?: number }) {
  const { query, maxResultados = 12 } = args || {};
  
  const q = String(query || "").toLowerCase().trim();
  if (!q) return [];
  
  try {
    const { searchSuggestions } = await import('../tools.js');
    const searchResult = await searchSuggestions(q);
    
    let products = searchResult.products || [];
    
    // Ranking simples por pre√ßo
    products.sort((a: any, b: any) => (a.price?.USD || 0) - (b.price?.USD || 0));
    const sorted = products.slice(0, Math.max(1, Math.min(50, maxResultados)));
    
    return sorted;
  } catch (error) {
    console.error('Erro na busca Gemini:', error);
    return [];
  }
}

========================================
5. M√ìDULO DE SESS√ÉO E PERSIST√äNCIA
========================================

// server/lib/gemini/session.ts
import { storage } from '../../storage.js';

export async function persistSessionAndMessage(sessionId: string, userId: string | undefined | null, message: string) {
  try {
    let session = await storage.getAssistantSession(sessionId);
    if (!session) {
      session = await storage.createAssistantSession({
        id: sessionId,
        userId: userId || null,
        metadata: { createdAt: new Date().toISOString(), provider: 'gemini' },
      });
    }
    
    await storage.createAssistantMessage({ 
      sessionId, 
      role: 'user', 
      content: message, 
      metadata: { timestamp: new Date().toISOString(), provider: 'gemini' } 
    });
  } catch (error) {
    console.warn('Erro ao salvar mensagem Gemini:', error);
  }
}

export async function getSessionMessages(sessionId: string) {
  try {
    const messages = await storage.getAssistantMessages(sessionId);
    return messages || [];
  } catch (error) {
    console.warn('Erro ao buscar mensagens Gemini:', error);
    return [];
  }
}

export async function salvarResposta(sessionId: string, text: string) {
  try {
    await storage.createAssistantMessage({
      sessionId,
      role: 'assistant',
      content: text,
      metadata: { 
        streamed: true, 
        timestamp: new Date().toISOString(), 
        provider: 'gemini'
      }
    });
  } catch (error) {
    console.warn('Erro ao salvar resposta Gemini:', error);
  }
}

========================================
6. M√ìDULO DE MEM√ìRIA DE USU√ÅRIO
========================================

// server/lib/gemini/memoria.ts
const memoriaUsuarios: Record<string, any> = {};

export async function getUserMemory(userId: string | undefined | null) {
  if (!userId) return {};
  return memoriaUsuarios[userId] || {};
}

export async function updateUserMemory(userId: string | undefined | null, dados: any) {
  if (!userId) return;
  memoriaUsuarios[userId] = {
    ...memoriaUsuarios[userId],
    ...dados
  };
}

========================================
7. FRONTEND - COMPONENTE PRINCIPAL (IGUAL)
========================================

O componente React permanece igual ao anterior, com toda funcionalidade de:
- Interface Gemini com visual diferenciado
- Chat em tempo real com streaming
- Integra√ß√£o com header
- Sugest√µes de autocomplete
- Overlay com resultados
- Anima√ß√µes e frases espec√≠ficas Gemini

========================================
8. NOVAS FUNCIONALIDADES IMPLEMENTADAS
========================================

‚úÖ **INTERPRETA√á√ÉO SEM√ÇNTICA AVAN√áADA**
- Produtos expandidos: tablet, fone, mouse, teclado, monitor, tv, smartwatch, airpods
- Modelos expandidos: s24, 16, pro, max, mini, se, plus, ultra, 1tb, 512gb
- Marcas expandidas: HP, Lenovo, Acer, Xiaomi
- Atributos expandidos: gamer, profissional, b√°sico, barato, caro, original, importado, nacional

‚úÖ **COMPARA√á√ÉO DE PRODUTOS**
- Detec√ß√£o autom√°tica: "iPhone 12 vs 13", "comparar Galaxy S22 e S23"
- Cat√°logo interno com especifica√ß√µes t√©cnicas
- Resposta formatada com comparativo detalhado
- Suporte para iPhone (12-16) e Galaxy (S22-S24)

‚úÖ **MELHORIAS NA RESPOSTA CONVERSACIONAL**
- Fun√ß√£o detectarSegmento() atualizada com notebooks
- Respostas mais din√¢micas e variadas
- Follow-up espec√≠fico por categoria de produto
- Suporte para notebooks: "gamer, profissional ou b√°sico?"

‚úÖ **FLUXO DE COMPARA√á√ÉO**
1. Usu√°rio: "iPhone 13 vs 15"
2. Sistema detecta compara√ß√£o
3. Extrai modelos automaticamente
4. Retorna comparativo detalhado
5. Convida para ver ofertas espec√≠ficas

========================================
9. CASOS DE USO EXPANDIDOS
========================================

**INTERPRETA√á√ÉO SEM√ÇNTICA:**
‚úÖ "Quero notebook gamer da Dell" ‚Üí "notebook gamer dell"
‚úÖ "Tem smartwatch Apple barato?" ‚Üí "smartwatch apple barato"
‚úÖ "Preciso de monitor 4K profissional" ‚Üí "monitor 4k profissional"

**COMPARA√á√ÉO DE PRODUTOS:**
‚úÖ "iPhone 13 versus 15" ‚Üí Comparativo completo
‚úÖ "Qual melhor: Galaxy S22 ou S23?" ‚Üí Comparativo completo  
‚úÖ "Compare iPhone 12 e 14" ‚Üí Comparativo completo

**CONTEXTO AVAN√áADO:**
‚úÖ "Me fala da linha 16" (ap√≥s buscar iPhone) ‚Üí "iphone 16"
‚úÖ "Quero o modelo b√°sico" (ap√≥s buscar notebook) ‚Üí "notebook b√°sico"
‚úÖ "Tem em 512GB?" (ap√≥s buscar smartphone) ‚Üí "smartphone 512gb"

========================================
FIM DO C√ìDIGO COMPLETO ATUALIZADO
========================================

Este arquivo cont√©m a vers√£o mais avan√ßada do assistente Gemini com:

üî• **NOVO:** Compara√ß√£o inteligente de produtos
üî• **NOVO:** Interpreta√ß√£o sem√¢ntica expandida (+ produtos, marcas, modelos)
üî• **NOVO:** Categoriza√ß√£o de notebooks (gamer/profissional/b√°sico)
üî• **NOVO:** Detec√ß√£o de at√© 16 produtos diferentes
üî• **NOVO:** Suporte a mais de 25 marcas

‚úÖ Filosofia Ask-Then-Show mantida
‚úÖ Fluxos conversacionais inteligentes  
‚úÖ Mem√≥ria de contexto avan√ßada
‚úÖ Interface React completa
‚úÖ Streaming de respostas
‚úÖ Integra√ß√£o com sistema de busca

O sistema agora resolve TODOS os casos de frases complexas, compara√ß√µes de produtos
e contextos avan√ßados, oferecendo uma experi√™ncia de IA conversacional completa.