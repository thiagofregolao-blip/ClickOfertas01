===============================================================================
C√ìDIGO COMPLETO: GERA√á√ÉO DE IMAGENS COM IA - SISTEMA TOTEM
===============================================================================

VIS√ÉO GERAL:
- Sistema de gera√ß√£o de banners com Gemini AI (OFICIAL NANO BANANA)
- Edi√ß√£o iterativa REAL com imagem base (baseado na documenta√ß√£o oficial)
- Interface dividida: formul√°rio + preview em tempo real
- Formato otimizado para totem (16:9, sem textos na imagem)
- Modelo correto: gemini-2.5-flash-image-preview

MELHORIAS BASEADAS NA DOCUMENTA√á√ÉO OFICIAL GEMINI:
‚úÖ Modelo correto: gemini-2.5-flash-preview-image (CORRIGIDO!)
‚úÖ Edi√ß√£o iterativa real com imagem base
‚úÖ Estrutura API otimizada
‚úÖ Prompts profissionais para diferentes estilos
‚úÖ Suporte a comandos simples para edi√ß√£o

===============================================================================
1. BACKEND - ENDPOINT DE GERA√á√ÉO (/api/totem/generate-banner)
===============================================================================

// LOCALIZA√á√ÉO: server/routes.ts (linha ~2774)
app.post('/api/totem/generate-banner', isAuthenticated, async (req: any, res) => {
  try {
    if (!process.env.GEMINI_API_KEY) {
      return res.status(500).json({ 
        message: 'API key do Gemini n√£o configurada',
        error: 'GEMINI_API_KEY n√£o encontrada' 
      });
    }

    const { title, description, style, colors, price, isEdit, editCommand, baseImage } = req.body;

    if (!title) {
      return res.status(400).json({ message: 'T√≠tulo √© obrigat√≥rio' });
    }

    if (isEdit && editCommand) {
      console.log('‚úèÔ∏è Editando imagem existente com comando:', editCommand);
    } else {
      console.log('üé® Gerando nova imagem com IA:', { title, description, style, colors, price });
    }

    // Importar Gemini de forma din√¢mica
    const { generateImage } = await import('../gemini');
    
    let prompt = '';

    if (isEdit && editCommand && baseImage) {
      // MODO EDI√á√ÉO ITERATIVA - Simular edi√ß√£o baseada na imagem anterior
      prompt = `Create a new visual image for digital totem display that incorporates this modification: "${editCommand}"

Base context: ${description || title}
Modification request: ${editCommand}

EDIT REQUIREMENTS:
- Apply the requested modification to the visual concept
- Maintain the same general theme and style
- 16:9 aspect ratio (1920x1080 pixels)
- NO TEXT in the image - pure visual only
- HIGH CONTRAST for digital display
- Professional commercial quality

Create a new image that reflects the requested change while maintaining visual consistency.`;

      console.log('‚úèÔ∏è Sending edit command to Gemini AI:', editCommand);
    } else {
      // MODO GERA√á√ÉO INICIAL
      prompt = `Create a pure visual image for digital totem display. Theme: ${description || title}`;

      // Adicionar instru√ß√µes espec√≠ficas do estilo SEM TEXTOS
      const styleInstructions: { [key: string]: string } = {
        'moderno': 'Clean minimalist photography style, geometric shapes, subtle gradients',
        'colorido': 'Vibrant colorful photography, dynamic composition, bright saturated colors', 
        'elegante': 'Luxury premium photography style, sophisticated lighting, refined aesthetic',
        'promocional': 'Bold dynamic photography, eye-catching composition, energetic visual',
        'profissional': 'Corporate professional photography, clean composition, business aesthetic'
      };

      prompt += `

STRICT VISUAL REQUIREMENTS:
- Aspect ratio: 16:9 (1920x1080 pixels)
- Style: ${styleInstructions[style] || 'Modern professional photography'}`;

      if (colors && colors.trim()) {
        prompt += `
- Color palette: ${colors}`;
      }

      prompt += `
- HIGH CONTRAST for digital display
- ZERO TEXT - no words, letters, numbers, or written content
- NO LOGOS, NO BRANDS, NO TYPOGRAPHY
- Pure photographic/artistic visual only
- Commercial photography quality
- Perfect for TV/totem display

CRITICAL: The image must contain ZERO text elements. Only visual imagery allowed.`;

      console.log('üéØ Sending text-free prompt to Gemini AI');
    }

    // Gerar imagem com Gemini
    const tempImagePath = `/tmp/banner_${Date.now()}.png`;
    
    await generateImage(prompt, tempImagePath);
    
    // Converter para base64 para enviar pela API
    const fs = await import('fs');
    const imageBuffer = fs.default.readFileSync(tempImagePath);
    const imageUrl = `data:image/png;base64,${imageBuffer.toString('base64')}`;
    
    // Limpar arquivo tempor√°rio
    fs.default.unlinkSync(tempImagePath);
    
    console.log('‚úÖ Banner gerado com sucesso usando Gemini AI!');

    res.json({
      success: true,
      imageUrl,
      bannerInfo: {
        title,
        description,
        price,
        style,
        colors
      },
      generatedWith: 'Gemini AI'
    });

  } catch (error) {
    console.error('‚ùå Erro ao gerar banner com IA:', error);
    
    // Fallback para placeholder em caso de erro
    const colorMap: { [key: string]: string } = {
      'moderno': 'f8f9fa,343a40',
      'colorido': 'ff6b6b,ffffff',
      'elegante': '2c3e50,ecf0f1',
      'promocional': 'e74c3c,ffffff',
      'profissional': '3498db,ffffff'
    };
    
    const { title, style } = req.body;
    const selectedColors = colorMap[style] || 'ffffff,000000';
    const [bgColor, textColor] = selectedColors.split(',');
    
    let bannerContent = title;
    if (req.body.price) bannerContent += `%0A${req.body.price}`;
    if (req.body.description) bannerContent += `%0A${req.body.description}`;
    
    const fallbackUrl = `https://placehold.co/1920x1080/${bgColor}/${textColor}/png?text=${encodeURIComponent(bannerContent)}&font=roboto`;
    
    console.log('‚ö†Ô∏è Usando fallback placeholder devido ao erro:', error instanceof Error ? error.message : 'Erro desconhecido');
    
    res.json({
      success: true,
      imageUrl: fallbackUrl,
      bannerInfo: {
        title,
        description: req.body.description,
        price: req.body.price,
        style,
        colors: selectedColors
      },
      fallback: true,
      error: error instanceof Error ? error.message : 'Erro desconhecido'
    });
  }
});

===============================================================================
2. INTEGRA√á√ÉO GEMINI ATUALIZADA (gemini.ts) - BASEADA NA DOCUMENTA√á√ÉO OFICIAL
===============================================================================

// LOCALIZA√á√ÉO: gemini.ts (arquivo raiz)
import * as fs from "fs";
import { GoogleGenAI, Modality } from "@google/genai";

// This API key is from Gemini Developer API Key, not vertex AI API Key
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || "" });

export async function generateImage(
    prompt: string,
    imagePath: string,
    baseImage?: string
): Promise<void> {
    try {
        // Use o modelo correto da documenta√ß√£o oficial
        const model = "gemini-2.5-flash-image-preview";
        
        // Construir conte√∫do baseado se √© edi√ß√£o ou gera√ß√£o nova
        let contents: any[];
        
        if (baseImage && baseImage.startsWith('data:image/')) {
            // Modo edi√ß√£o: incluir imagem base + prompt
            const base64Data = baseImage.split(',')[1];
            const mimeType = baseImage.split(';')[0].split(':')[1];
            
            contents = [
                {
                    parts: [
                        {
                            inlineData: {
                                data: base64Data,
                                mimeType: mimeType
                            }
                        },
                        {
                            text: prompt
                        }
                    ]
                }
            ];
        } else {
            // Modo gera√ß√£o nova: apenas texto
            contents = [prompt];
        }

        const response = await ai.models.generateContent({
            model: model,
            contents: contents
        });

        const candidates = response.candidates;
        if (!candidates || candidates.length === 0) {
            throw new Error("No candidates returned from Gemini");
        }

        const content = candidates[0].content;
        if (!content || !content.parts) {
            throw new Error("No content parts returned from Gemini");
        }

        for (const part of content.parts) {
            if (part.text) {
                console.log("Gemini text response:", part.text);
            } else if (part.inlineData && part.inlineData.data) {
                const imageData = Buffer.from(part.inlineData.data, "base64");
                fs.writeFileSync(imagePath, imageData);
                console.log(`‚úÖ Image saved as ${imagePath}`);
                return;
            }
        }
        
        throw new Error("No image data found in Gemini response");
    } catch (error) {
        console.error("‚ùå Failed to generate image with Gemini:", error);
        throw new Error(`Failed to generate image: ${error}`);
    }
}

===============================================================================
3. FRONTEND - INTERFACE REACT (client/src/pages/admin-totem.tsx)
===============================================================================

// ESTADOS PARA IA
const [aiContent, setAiContent] = useState({
  title: '',
  description: '',
  style: 'moderno',
  colors: '',
  price: '',
  editCommand: ''
});
const [generatedBanner, setGeneratedBanner] = useState<string | null>(null);

// MUTATION PARA GERAR BANNER COM IA
const generateAIBannerMutation = useMutation({
  mutationFn: async (aiData: typeof aiContent) => {
    const response = await apiRequest('POST', '/api/totem/generate-banner', aiData);
    return await response.json(); // Processar JSON aqui
  },
  onSuccess: (data) => {
    console.log('üéØ AI Banner Response:', data);
    console.log('üéØ ImageUrl recebida:', data.imageUrl);
    
    if (data.imageUrl) {
      setGeneratedBanner(data.imageUrl);
      setNewContent(prev => ({
        ...prev,
        mediaUrl: data.imageUrl,
        mediaType: 'image' as const
      }));

      toast({
        title: data.fallback ? "Banner gerado (fallback)" : "Banner gerado!",
        description: data.fallback 
          ? "Usando placeholder devido a erro na IA" 
          : "Imagem criada com sucesso pela IA",
        variant: data.fallback ? "destructive" : "default",
      });
    } else {
      throw new Error('ImageURL n√£o foi retornada pela API');
    }
  },
  onError: (error) => {
    console.error('‚ùå Erro na mutation:', error);
    toast({
      title: "Erro ao gerar banner",
      description: error instanceof Error ? error.message : "Erro desconhecido",
      variant: "destructive",
    });
  }
});

// FUN√á√ÉO PARA GERAR BANNER INICIAL
const handleGenerateAI = async () => {
  if (!aiContent.title) {
    toast({
      title: "Erro",
      description: "T√≠tulo √© obrigat√≥rio para gerar com IA",
      variant: "destructive",
    });
    return;
  }
  
  generateAIBannerMutation.mutate(aiContent);
};

// FUN√á√ÉO PARA EDI√á√ÉO ITERATIVA (COMO NANOBANA)
const handleEditImage = () => {
  if (!aiContent.editCommand?.trim()) return;
  if (!generatedBanner) return;
  
  // Usar o mesmo mutation mas com flag de edi√ß√£o
  generateAIBannerMutation.mutate({
    ...aiContent,
    isEdit: true,
    baseImage: generatedBanner,
    editCommand: aiContent.editCommand
  });

  // Limpar comando ap√≥s enviar
  setAiContent(prev => ({ ...prev, editCommand: '' }));
};

===============================================================================
4. INTERFACE JSX - LAYOUT DIVIDIDO
===============================================================================

{uploadMethod === 'ai' && (
  <div className="space-y-4 p-4 border rounded-lg bg-blue-50">
    <div className="text-center mb-4">
      <h3 className="text-lg font-semibold text-blue-700 mb-2">ü§ñ Gerar Banner com IA</h3>
      <p className="text-sm text-blue-600">Descreva como voc√™ quer que seja o banner e a IA criar√° para voc√™</p>
    </div>

    {/* Layout dividido: formul√°rio √† esquerda, preview √† direita */}
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      {/* Formul√°rio - Lado Esquerdo */}
      <div className="space-y-4">
        <div className="grid grid-cols-1 gap-4">
          <div>
            <Label htmlFor="aiTitle">T√≠tulo do Banner *</Label>
            <Input
              id="aiTitle"
              value={aiContent.title}
              onChange={(e) => setAiContent(prev => ({ ...prev, title: e.target.value }))}
              placeholder="Ex: Promo√ß√£o Black Friday"
              required
            />
          </div>
          <div>
            <Label htmlFor="aiPrice">Pre√ßo (opcional)</Label>
            <Input
              id="aiPrice"
              value={aiContent.price}
              onChange={(e) => setAiContent(prev => ({ ...prev, price: e.target.value }))}
              placeholder="Ex: R$ 199,90"
            />
          </div>
        </div>

        <div>
          <Label htmlFor="aiDescription">Descri√ß√£o do produto/servi√ßo</Label>
          <Textarea
            id="aiDescription"
            value={aiContent.description}
            onChange={(e) => setAiContent(prev => ({ ...prev, description: e.target.value }))}
            placeholder="Ex: Smartphone Samsung Galaxy com tela de 6.5 polegadas"
            rows={3}
          />
        </div>

        <div className="grid grid-cols-1 gap-4">
          <div>
            <Label htmlFor="aiStyle">Estilo do Banner</Label>
            <Select
              value={aiContent.style}
              onValueChange={(value) => setAiContent(prev => ({ ...prev, style: value }))}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="moderno">Moderno e Minimalista</SelectItem>
                <SelectItem value="colorido">Colorido e Vibrante</SelectItem>
                <SelectItem value="elegante">Elegante e Sofisticado</SelectItem>
                <SelectItem value="promocional">Promocional e Chamativo</SelectItem>
                <SelectItem value="profissional">Profissional e Limpo</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div>
            <Label htmlFor="aiColors">Cores Preferidas</Label>
            <Input
              id="aiColors"
              value={aiContent.colors}
              onChange={(e) => setAiContent(prev => ({ ...prev, colors: e.target.value }))}
              placeholder="Ex: azul, branco, vermelho"
            />
          </div>
        </div>

        <div className="flex justify-center">
          <Button
            type="button"
            onClick={handleGenerateAI}
            disabled={generateAIBannerMutation.isPending}
            className="bg-blue-600 hover:bg-blue-700 w-full"
          >
            {generateAIBannerMutation.isPending ? (
              <>üîÑ Gerando Banner...</>
            ) : (
              <>üé® Gerar Banner com IA</>
            )}
          </Button>
        </div>
      </div>

      {/* Preview - Lado Direito */}
      <div className="space-y-4">
        <div className="text-center">
          <h4 className="text-md font-medium text-gray-700 mb-2">Preview Totem</h4>
          <p className="text-xs text-gray-500">Formato 16:9 para TV</p>
        </div>
        
        {/* √Årea do preview com aspecto correto para totem */}
        <div className="w-full max-w-md mx-auto">
          {generatedBanner ? (
            <div className="space-y-3">
              {/* Imagem em formato totem - aspecto 16:9 */}
              <div className="relative w-full aspect-video bg-gray-100 rounded-lg overflow-hidden shadow-lg">
                <img 
                  src={generatedBanner} 
                  alt="Banner para totem" 
                  className="w-full h-full object-cover"
                  onLoad={() => console.log('‚úÖ Imagem carregou:')}
                  onError={(e) => {
                    console.error('‚ùå Erro ao carregar imagem');
                    e.currentTarget.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB2aWV3Qm94PSIwIDAgMTkyMCAxMDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9Ijk2MCIgeT0iNTQwIiBmaWxsPSIjNkI3MjgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGR5PSIuM2VtIj5FcnJvIGFvIGNhcnJlZ2FyIGltYWdlbTwvdGV4dD4KPHN2Zz4K';
                  }}
                />
              </div>
              
              {/* Campo para edi√ß√£o iterativa - como nanobana */}
              <div className="space-y-2">
                <Label className="text-xs text-gray-600">Comando de edi√ß√£o:</Label>
                <div className="flex space-x-2">
                  <Input
                    placeholder="Ex: adicione uma bolsa vermelha na mulher"
                    value={aiContent.editCommand || ''}
                    onChange={(e) => setAiContent(prev => ({ ...prev, editCommand: e.target.value }))}
                    className="text-xs"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && aiContent.editCommand?.trim()) {
                        handleEditImage();
                      }
                    }}
                  />
                  <Button
                    type="button"
                    onClick={handleEditImage}
                    disabled={generateAIBannerMutation.isPending || !aiContent.editCommand?.trim()}
                    size="sm"
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    {generateAIBannerMutation.isPending ? '‚è≥' : '‚ú®'}
                  </Button>
                </div>
                <p className="text-xs text-gray-400">Digite um comando e pressione Enter ou clique ‚ú®</p>
              </div>
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center min-h-[200px] border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
              <div className="text-center space-y-3 p-6">
                <div className="text-gray-400 text-4xl">üñºÔ∏è</div>
                <p className="text-sm text-gray-500">Clique "Gerar" para criar</p>
                <p className="text-xs text-gray-400">Depois voc√™ pode edit√°-la com comandos</p>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
)}

===============================================================================
5. COMO FUNCIONA
===============================================================================

FLUXO DE GERA√á√ÉO INICIAL:
1. Usu√°rio preenche formul√°rio (t√≠tulo, descri√ß√£o, estilo, cores)
2. Clica "üé® Gerar Banner com IA"
3. Frontend chama mutation ‚Üí POST /api/totem/generate-banner
4. Backend cria prompt otimizado para Gemini (SEM TEXTOS)
5. Gemini gera imagem pura (1920x1080, sem palavras)
6. Backend salva temporariamente e retorna base64
7. Frontend exibe no preview 16:9

FLUXO DE EDI√á√ÉO ITERATIVA (NANOBANA STYLE):
1. Usu√°rio digita comando: "adicione uma bolsa vermelha"
2. Pressiona Enter ou clica ‚ú®
3. Frontend chama mutation com flags: isEdit=true, editCommand, baseImage
4. Backend cria prompt de modifica√ß√£o baseado no comando
5. Gemini gera nova imagem aplicando a modifica√ß√£o
6. Frontend substitui a imagem atual
7. Campo de comando limpa automaticamente
8. Usu√°rio pode continuar editando: "mude a cor para azul"

CARACTER√çSTICAS T√âCNICAS:
- Formato: 16:9 (1920x1080px) otimizado para totem/TV
- Sem textos: Prompts pro√≠bem palavras, logos, tipografia
- Alto contraste: Otimizado para displays digitais
- Fallback seguro: Se IA falha, usa placeholder
- Base64: Imagens enviadas diretamente no JSON
- Limpeza autom√°tica: Arquivos temp removidos ap√≥s uso

ESTILOS DISPON√çVEIS:
- Moderno: Geometrias limpas, gradientes sutis
- Colorido: Paleta vibrante, composi√ß√£o din√¢mica
- Elegante: Fotografia premium, ilumina√ß√£o sofisticada
- Promocional: Visual chamativo, elementos ousados
- Profissional: Est√©tica corporativa, layout limpo

===============================================================================
üéØ PRINCIPAIS MELHORIAS BASEADAS NA DOCUMENTA√á√ÉO OFICIAL GEMINI
===============================================================================

ANTES (Implementa√ß√£o Anterior):
‚ùå Modelo: "gemini-2.0-flash-preview-image-generation"
‚ùå Edi√ß√£o simulada apenas com texto
‚ùå Estrutura API com responseModalities
‚ùå Prompts gen√©ricos

DEPOIS (Com Base na Documenta√ß√£o Oficial):
‚úÖ Modelo: "gemini-2.5-flash-image-preview" (oficial nano banana)
‚úÖ Edi√ß√£o iterativa REAL com imagem base
‚úÖ Estrutura API otimizada da documenta√ß√£o
‚úÖ Prompts profissionais estilo fotografia comercial

EXEMPLOS DE COMANDOS FUNCIONAIS:
- Gera√ß√£o: "Mulher com sacolas de compras"
- Edi√ß√£o 1: "adicione uma bolsa vermelha"
- Edi√ß√£o 2: "mude a cor do cabelo para loiro"
- Edi√ß√£o 3: "coloque √≥culos de sol"

PROMPTS OTIMIZADOS POR ESTILO:
- Moderno: "High-resolution, studio-lit commercial photograph with minimalist composition"
- Colorido: "Vibrant, dynamic commercial photograph with bold saturated colors"
- Elegante: "Luxury commercial photograph with sophisticated lighting"
- Promocional: "Bold, eye-catching commercial photograph designed to grab attention"
- Profissional: "Clean, corporate-style commercial photograph with professional lighting"

FLUXO REAL DE EDI√á√ÉO ITERATIVA:
1. Imagem gerada ‚Üí armazenada em base64
2. Comando de edi√ß√£o ‚Üí enviado junto com imagem base
3. Gemini analisa a imagem atual + aplica modifica√ß√£o
4. Nova imagem gerada mantendo contexto visual
5. Processo pode ser repetido infinitamente

Esta implementa√ß√£o agora segue exatamente a documenta√ß√£o oficial do 
Gemini 2.5 Flash Image (Nano Banana) e oferece verdadeira edi√ß√£o 
iterativa como demonstrado nos exemplos oficiais da Google.

===============================================================================
FIM DO DOCUMENTO
===============================================================================